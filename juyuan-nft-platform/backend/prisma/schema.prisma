// Prisma Schema for 钜园农业NFT平台
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id                String    @id @default(uuid())
  email             String?   @unique
  phone             String?   @unique
  username          String?
  passwordHash      String?
  walletAddress     String?   @unique
  avatar            String?
  role              UserRole  @default(USER)
  kycStatus         KYCStatus @default(NOT_SUBMITTED)
  pushToken         String?
  locale            String    @default("zh-CN")
  currency          String    @default("CNY")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  nfts              NFT[]
  purchases         Purchase[]
  kycApplications   KYC[]
  notifications     Notification[]
  addresses         Address[]
  deliveryRequests  DeliveryRequest[]
  
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
  FARMER
}

enum KYCStatus {
  NOT_SUBMITTED
  PENDING
  APPROVED
  REJECTED
}

// NFT表
model NFT {
  id              String          @id @default(uuid())
  tokenId         Int             @unique
  productType     String
  quantity        Decimal
  unit            String          @default("kg")
  qualityGrade    String
  harvestDate     DateTime
  originBase      String
  batchId         String?
  ipfsHash        String?
  metadataUri     String?
  contractAddress String?
  mintTxHash      String?
  deliveryStatus  DeliveryStatus  @default(PENDING)
  ownerId         String?
  owner           User?           @relation(fields: [ownerId], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  traceEvents     TraceEvent[]
  deliveryRequests DeliveryRequest[]
  
  @@map("nfts")
}

enum DeliveryStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
}

// 预售表
model Presale {
  id               String        @id @default(uuid())
  productType      String
  maxSupply        Int
  currentSupply    Int           @default(0)
  price            Decimal
  currency         String        @default("CNY")
  startTime        DateTime
  endTime          DateTime
  minPurchase      Int           @default(1)
  maxPurchase      Int           @default(100)
  whitelistEnabled Boolean       @default(false)
  status           PresaleStatus @default(UPCOMING)
  originBase       String?
  harvestDate      DateTime?
  description      String?
  image            String?
  metadata         Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  
  // Relations
  purchases        Purchase[]
  whitelist        Whitelist[]
  
  @@map("presales")
}

enum PresaleStatus {
  UPCOMING
  ACTIVE
  ENDED
  CANCELLED
}

// 购买记录表
model Purchase {
  id            String          @id @default(uuid())
  presaleId     String
  presale       Presale         @relation(fields: [presaleId], references: [id])
  userId        String
  user          User            @relation(fields: [userId], references: [id])
  walletAddress String?
  quantity      Int
  unitPrice     Decimal
  totalAmount   Decimal
  currency      String
  paymentMethod String
  paymentId     String?
  status        PurchaseStatus  @default(PENDING)
  paidAt        DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@map("purchases")
}

enum PurchaseStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

// 白名单表
model Whitelist {
  id        String   @id @default(uuid())
  presaleId String
  presale   Presale  @relation(fields: [presaleId], references: [id])
  address   String
  createdAt DateTime @default(now())
  
  @@unique([presaleId, address])
  @@map("whitelists")
}

// 溯源事件表
model TraceEvent {
  id          String       @id @default(uuid())
  tokenId     Int
  nft         NFT          @relation(fields: [tokenId], references: [tokenId])
  eventType   String
  description String
  location    Json?
  operator    String?
  txHash      String?
  metadata    Json?
  timestamp   DateTime     @default(now())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relations
  media       TraceMedia[]
  
  @@map("trace_events")
}

// 溯源媒体表
model TraceMedia {
  id          String     @id @default(uuid())
  eventId     String
  event       TraceEvent @relation(fields: [eventId], references: [id])
  type        String
  url         String
  description String?
  createdAt   DateTime   @default(now())
  
  @@map("trace_media")
}

// KYC表
model KYC {
  id               String    @id @default(uuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id])
  documentType     String
  documentNumber   String
  fullName         String
  dateOfBirth      DateTime
  nationality      String
  documentFrontUrl String
  documentBackUrl  String?
  selfieUrl        String
  status           KYCStatus @default(PENDING)
  rejectedReason   String?
  reviewerId       String?
  reviewedAt       DateTime?
  approvedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@map("kyc_applications")
}

// AML检查表
model AMLCheck {
  id                  String   @id @default(uuid())
  userId              String
  transactionType     String
  amount              Decimal
  currency            String
  walletAddress       String?
  riskLevel           String
  userRiskLevel       String
  transactionRiskLevel String
  walletRiskLevel     String?
  passed              Boolean
  checkedAt           DateTime @default(now())
  
  @@map("aml_checks")
}

// 通知表
model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  title     String
  content   String
  data      Json?
  status    String   @default("PENDING")
  sentAt    DateTime?
  read      Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())
  
  @@map("notifications")
}

// 通知模板表
model NotificationTemplate {
  id        String   @id @default(uuid())
  name      String   @unique
  type      String
  subject   String
  content   String
  variables String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("notification_templates")
}

// 收货地址表
model Address {
  id          String  @id @default(uuid())
  userId      String
  user        User    @relation(fields: [userId], references: [id])
  name        String
  phone       String
  province    String
  city        String
  district    String
  address     String
  postalCode  String?
  isDefault   Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  deliveryRequests DeliveryRequest[]
  
  @@map("addresses")
}

// 交付请求表
model DeliveryRequest {
  id              String          @id @default(uuid())
  nftId           String
  nft             NFT             @relation(fields: [nftId], references: [id])
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  addressId       String
  address         Address         @relation(fields: [addressId], references: [id])
  status          DeliveryStatus  @default(PENDING)
  trackingNumber  String?
  carrier         String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@map("delivery_requests")
}

// 支付记录表
model Payment {
  id            String        @id @default(uuid())
  orderId       String
  orderType     String
  amount        Decimal
  currency      String
  method        String
  status        PaymentStatus @default(PENDING)
  transactionId String?
  metadata      Json?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

// 退款记录表
model Refund {
  id          String       @id @default(uuid())
  paymentId   String
  amount      Decimal
  reason      String
  status      RefundStatus @default(PENDING)
  processedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@map("refunds")
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

// 系统配置表
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("system_configs")
}
