# Lychee NFT Platform Makefile
# æä¾›ä¾¿æ·çš„å‘½ä»¤è¡Œæ¥å£

.PHONY: help dev prod start stop restart status logs clean backup restore update health

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# é¢œè‰²å®šä¹‰
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m # No Color

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "$(BLUE)Lychee NFT Platform - ç®¡ç†å‘½ä»¤$(NC)"
	@echo ""
	@echo "$(GREEN)å¼€å‘ç¯å¢ƒ:$(NC)"
	@echo "  make dev              å¯åŠ¨å¼€å‘ç¯å¢ƒ"
	@echo "  make dev-stop         åœæ­¢å¼€å‘ç¯å¢ƒ"
	@echo "  make dev-logs         æŸ¥çœ‹å¼€å‘ç¯å¢ƒæ—¥å¿—"
	@echo ""
	@echo "$(GREEN)ç”Ÿäº§ç¯å¢ƒ:$(NC)"
	@echo "  make prod             å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ"
	@echo "  make prod-stop        åœæ­¢ç”Ÿäº§ç¯å¢ƒ"
	@echo "  make prod-logs        æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ—¥å¿—"
	@echo ""
	@echo "$(GREEN)é€šç”¨å‘½ä»¤:$(NC)"
	@echo "  make start            å¯åŠ¨æœåŠ¡"
	@echo "  make stop             åœæ­¢æœåŠ¡"
	@echo "  make restart          é‡å¯æœåŠ¡"
	@echo "  make status           æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  make logs             æŸ¥çœ‹æ—¥å¿—"
	@echo "  make ps               æŸ¥çœ‹å®¹å™¨åˆ—è¡¨"
	@echo ""
	@echo "$(GREEN)æ•°æ®åº“:$(NC)"
	@echo "  make db-backup        å¤‡ä»½æ•°æ®åº“"
	@echo "  make db-restore FILE=<file>  æ¢å¤æ•°æ®åº“"
	@echo "  make db-shell         è¿›å…¥æ•°æ®åº“"
	@echo ""
	@echo "$(GREEN)ç»´æŠ¤:$(NC)"
	@echo "  make clean            æ¸…ç†æœªä½¿ç”¨çš„èµ„æº"
	@echo "  make update           æ›´æ–°æœåŠ¡"
	@echo "  make health           å¥åº·æ£€æŸ¥"
	@echo "  make urls             æ˜¾ç¤ºè®¿é—®åœ°å€"
	@echo ""

# ==================== å¼€å‘ç¯å¢ƒ ====================

dev: ## å¯åŠ¨å¼€å‘ç¯å¢ƒ
	@echo "$(GREEN)å¯åŠ¨å¼€å‘ç¯å¢ƒ...$(NC)"
	@cp -n .env.development .env 2>/dev/null || true
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
	@echo "$(GREEN)å¼€å‘ç¯å¢ƒå¯åŠ¨æˆåŠŸ!$(NC)"
	@make urls

dev-stop: ## åœæ­¢å¼€å‘ç¯å¢ƒ
	@echo "$(YELLOW)åœæ­¢å¼€å‘ç¯å¢ƒ...$(NC)"
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml down

dev-logs: ## æŸ¥çœ‹å¼€å‘ç¯å¢ƒæ—¥å¿—
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml logs -f

dev-build: ## é‡æ–°æ„å»ºå¼€å‘ç¯å¢ƒ
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml build --no-cache

# ==================== ç”Ÿäº§ç¯å¢ƒ ====================

prod: ## å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
	@echo "$(GREEN)å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ...$(NC)"
	@if [ ! -f .env ]; then \
		echo "$(YELLOW)è­¦å‘Š: .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç”Ÿäº§ç¯å¢ƒæ¨¡æ¿$(NC)"; \
		cp .env.production .env; \
		echo "$(YELLOW)è¯·ç¼–è¾‘ .env æ–‡ä»¶å¹¶ä¿®æ”¹æ‰€æœ‰å¯†ç !$(NC)"; \
		exit 1; \
	fi
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
	@echo "$(GREEN)ç”Ÿäº§ç¯å¢ƒå¯åŠ¨æˆåŠŸ!$(NC)"
	@make urls

prod-stop: ## åœæ­¢ç”Ÿäº§ç¯å¢ƒ
	@echo "$(YELLOW)åœæ­¢ç”Ÿäº§ç¯å¢ƒ...$(NC)"
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml down

prod-logs: ## æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

prod-build: ## é‡æ–°æ„å»ºç”Ÿäº§ç¯å¢ƒ
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache

# ==================== é€šç”¨å‘½ä»¤ ====================

start: ## å¯åŠ¨æœåŠ¡
	@echo "$(GREEN)å¯åŠ¨æœåŠ¡...$(NC)"
	docker-compose up -d

stop: ## åœæ­¢æœåŠ¡
	@echo "$(YELLOW)åœæ­¢æœåŠ¡...$(NC)"
	docker-compose down

restart: ## é‡å¯æœåŠ¡
	@echo "$(YELLOW)é‡å¯æœåŠ¡...$(NC)"
	docker-compose restart

status: ## æŸ¥çœ‹æœåŠ¡çŠ¶æ€
	@docker-compose ps

logs: ## æŸ¥çœ‹æ—¥å¿—
	@docker-compose logs -f --tail=100

ps: ## æŸ¥çœ‹å®¹å™¨åˆ—è¡¨
	@docker-compose ps -a

# ==================== æ•°æ®åº“ ====================

db-backup: ## å¤‡ä»½æ•°æ®åº“
	@echo "$(GREEN)å¤‡ä»½æ•°æ®åº“...$(NC)"
	@./scripts/manage.sh backup

db-restore: ## æ¢å¤æ•°æ®åº“ (ä½¿ç”¨ FILE=<file>)
	@if [ -z "$(FILE)" ]; then \
		echo "$(YELLOW)è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶: make db-restore FILE=<file>$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)æ¢å¤æ•°æ®åº“...$(NC)"
	@./scripts/manage.sh restore $(FILE)

db-shell: ## è¿›å…¥æ•°æ®åº“
	@docker-compose exec postgres psql -U user lychee_db

# ==================== ç»´æŠ¤ ====================

clean: ## æ¸…ç†æœªä½¿ç”¨çš„èµ„æº
	@echo "$(YELLOW)æ¸…ç† Docker èµ„æº...$(NC)"
	@docker system prune -f
	@echo "$(GREEN)æ¸…ç†å®Œæˆ!$(NC)"

update: ## æ›´æ–°æœåŠ¡
	@echo "$(GREEN)æ›´æ–°æœåŠ¡...$(NC)"
	@git pull
	@docker-compose build --no-cache
	@docker-compose up -d
	@echo "$(GREEN)æ›´æ–°å®Œæˆ!$(NC)"

health: ## å¥åº·æ£€æŸ¥
	@echo "$(GREEN)æ‰§è¡Œå¥åº·æ£€æŸ¥...$(NC)"
	@./scripts/manage.sh health

urls: ## æ˜¾ç¤ºè®¿é—®åœ°å€
	@echo ""
	@echo "$(BLUE)========================================$(NC)"
	@echo "$(BLUE)æœåŠ¡è®¿é—®åœ°å€$(NC)"
	@echo "$(BLUE)========================================$(NC)"
	@echo "ğŸŒ å‰ç«¯åº”ç”¨:          http://localhost"
	@echo "ğŸ”Œ åç«¯ API:          http://localhost/api"
	@echo "ğŸ“Š Grafana ç›‘æ§:      http://localhost:3001"
	@echo "ğŸ“ˆ Prometheus:        http://localhost:9090"
	@echo "ğŸ—„ï¸  pgAdmin:          http://localhost:5050"
	@echo "ğŸ”´ Redis Commander:   http://localhost:8081"
	@echo "$(BLUE)========================================$(NC)"
	@echo ""

# ==================== å®¹å™¨æ“ä½œ ====================

shell-frontend: ## è¿›å…¥å‰ç«¯å®¹å™¨
	@docker-compose exec frontend sh

shell-backend: ## è¿›å…¥åç«¯å®¹å™¨
	@docker-compose exec backend sh

shell-postgres: ## è¿›å…¥æ•°æ®åº“å®¹å™¨
	@docker-compose exec postgres sh

shell-redis: ## è¿›å…¥ Redis å®¹å™¨
	@docker-compose exec redis sh

# ==================== ç›‘æ§ ====================

monitoring-start: ## å¯åŠ¨ç›‘æ§æœåŠ¡
	@echo "$(GREEN)å¯åŠ¨ç›‘æ§æœåŠ¡...$(NC)"
	@docker-compose --profile monitoring up -d prometheus grafana node-exporter postgres-exporter redis-exporter

monitoring-stop: ## åœæ­¢ç›‘æ§æœåŠ¡
	@echo "$(YELLOW)åœæ­¢ç›‘æ§æœåŠ¡...$(NC)"
	@docker-compose stop prometheus grafana node-exporter postgres-exporter redis-exporter
