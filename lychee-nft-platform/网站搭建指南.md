# 钜园农业NFT预售平台 - 完整搭建指南

## 🎯 项目概述

基于您的完整需求文档（FIP、PRD、产品设计文档），我已经为您搭建了完整的NFT预售平台基础架构。

---

## ✅ 已完成的工作

###  1. **项目结构初始化** ✅

```
lychee-nft-platform/
├── backend/              # 后端服务 (Node.js + Express + Prisma)
├── frontend/             # 前端应用 (Next.js + React + TailwindCSS)
├── contracts/            # 智能合约 (Solidity + Hardhat)
├── deployment/           # 部署配置 (Docker + Docker Compose)
└── docs/                 # 文档
```

### 2. **依赖配置** ✅

已创建所有 `package.json` 文件：
- ✅ 根目录 workspace 配置
- ✅ 后端依赖（Express、Prisma、Redis、JWT等）
- ✅ 前端依赖（Next.js、Wagmi、RainbowKit、i18next等）
- ✅ 智能合约依赖（Hardhat、OpenZeppelin等）

### 3. **数据库Schema** ✅

已创建完整的 Prisma Schema，包含：
- ✅ 用户系统（多角色、KYC）
- ✅ 果园管理
- ✅ 预售活动
- ✅ 订单管理
- ✅ NFT管理
- ✅ 支付/退款
- ✅ 评价系统
- ✅ 通知系统

### 4. **后端服务** ✅

已创建核心后端框架：
- ✅ Express服务器入口
- ✅ WebSocket支持
- ✅ 安全中间件
- ✅ 日志系统
- ✅ 错误处理

### 5. **智能合约** ✅

已准备智能合约修复版本：
- ✅ NFT合约（ERC-721）
- ✅ 托管合约（防重入、精确分配）

---

## 🚀 快速开始（15分钟启动）

### 步骤 1: 安装依赖

```bash
cd /Users/fancyfizzy/Downloads/RWA/lychee-nft-platform

# 安装根依赖
npm install

# 安装后端依赖
cd backend && npm install

# 安装前端依赖
cd ../frontend && npm install

# 安装合约依赖
cd ../contracts && npm install

cd ..
```

### 步骤 2: 配置环境变量

```bash
# 后端环境变量
cat > backend/.env << 'EOF'
# 服务器配置
PORT=5000
NODE_ENV=development
FRONTEND_URL=http://localhost:3000

# 数据库
DATABASE_URL="postgresql://postgres:password@localhost:5432/lychee_nft?schema=public"

# Redis
REDIS_URL="redis://localhost:6379"

# JWT密钥
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
JWT_EXPIRES_IN="7d"

# 区块链
BLOCKCHAIN_NETWORK="BSC_TESTNET"
RPC_URL="https://data-seed-prebsc-1-s1.binance.org:8545/"
PRIVATE_KEY="your-private-key-here"

# NFT合约地址（部署后填写）
NFT_CONTRACT_ADDRESS=""
ESCROW_CONTRACT_ADDRESS=""

# 文件上传
UPLOAD_DIR="./uploads"
MAX_FILE_SIZE=10485760

# 邮件服务（可选）
SMTP_HOST="smtp.gmail.com"
SMTP_PORT=587
SMTP_USER="your-email@gmail.com"
SMTP_PASS="your-app-password"

# 微信支付（可选）
WECHAT_APP_ID=""
WECHAT_MCH_ID=""
WECHAT_API_KEY=""

# 支付宝（可选）
ALIPAY_APP_ID=""
ALIPAY_PRIVATE_KEY=""
EOF

# 前端环境变量
cat > frontend/.env.local << 'EOF'
# API配置
NEXT_PUBLIC_API_URL=http://localhost:5000/api
NEXT_PUBLIC_WS_URL=http://localhost:5000

# 区块链配置
NEXT_PUBLIC_CHAIN_ID=97
NEXT_PUBLIC_CHAIN_NAME="BSC Testnet"
NEXT_PUBLIC_RPC_URL="https://data-seed-prebsc-1-s1.binance.org:8545/"

# NFT合约地址（部署后填写）
NEXT_PUBLIC_NFT_CONTRACT_ADDRESS=""
NEXT_PUBLIC_ESCROW_CONTRACT_ADDRESS=""

# WalletConnect项目ID（从 https://cloud.walletconnect.com/ 获取）
NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID="your-project-id"

# 分析（可选）
NEXT_PUBLIC_GA_ID=""
EOF

# 合约环境变量
cat > contracts/.env << 'EOF'
# BSC Testnet
BSC_TESTNET_RPC_URL="https://data-seed-prebsc-1-s1.binance.org:8545/"
BSC_TESTNET_PRIVATE_KEY="your-private-key-here"

# BSC Mainnet
BSC_MAINNET_RPC_URL="https://bsc-dataseed1.binance.org/"
BSC_MAINNET_PRIVATE_KEY=""

# BscScan API Key（用于合约验证）
BSCSCAN_API_KEY="your-bscscan-api-key"

# 合约配置
PLATFORM_ADDRESS="your-platform-wallet-address"
EOF
```

### 步骤 3: 启动数据库

```bash
# 使用 Docker 启动 PostgreSQL 和 Redis
cd deployment/docker
docker-compose up -d postgres redis

# 或手动安装并启动
# PostgreSQL: https://www.postgresql.org/download/
# Redis: https://redis.io/download/
```

### 步骤 4: 初始化数据库

```bash
cd backend

# 生成 Prisma Client
npx prisma generate

# 运行数据库迁移
npx prisma migrate dev --name init

# （可选）填充测试数据
npx prisma db seed
```

### 步骤 5: 启动开发服务器

```bash
# 在项目根目录

# 同时启动前后端
npm run dev

# 或分别启动：
# Terminal 1: 启动后端
cd backend && npm run dev

# Terminal 2: 启动前端
cd frontend && npm run dev
```

### 步骤 6: 访问应用

- 🌐 **前端**: http://localhost:3000
- 🔧 **后端API**: http://localhost:5000/api
- 💚 **健康检查**: http://localhost:5000/health
- 📊 **Prisma Studio**: `cd backend && npx prisma studio` → http://localhost:5555

---

## 📦 核心功能实现状态

### ✅ 已实现
- [x] 项目基础架构
- [x] 数据库模型设计
- [x] 后端服务框架
- [x] 智能合约修复版本
- [x] Docker部署配置

### 🚧 待实现（优先级排序）

#### 第1周：核心API开发
- [ ] 用户认证API（注册、登录、JWT）
- [ ] 预售管理API（CRUD、状态管理）
- [ ] 订单API（创建、支付、状态更新）
- [ ] 文件上传API

#### 第2周：前端页面开发
- [ ] 首页（预售列表、筛选）
- [ ] 预售详情页
- [ ] 购买流程页
- [ ] 用户个人中心
- [ ] 订单管理页

#### 第3周：Web3集成
- [ ] 部署智能合约
- [ ] 钱包连接（MetaMask、WalletConnect）
- [ ] NFT铸造逻辑
- [ ] 托管支付集成

#### 第4周：支付与完善
- [ ] 加密货币支付
- [ ] 传统支付集成（微信、支付宝）
- [ ] 管理后台
- [ ] 测试与优化

---

## 📚 详细实施指南

### 一、后端API开发

#### 1. 用户认证服务

创建 `backend/src/services/auth.service.ts`:

```typescript
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { prisma } from '../index';

export class AuthService {
  // 注册
  async register(data: { email: string; password: string; username: string }) {
    const hashedPassword = await bcrypt.hash(data.password, 10);
    
    const user = await prisma.user.create({
      data: {
        email: data.email,
        username: data.username,
        password_hash: hashedPassword,
      },
    });
    
    const token = jwt.sign(
      { userId: user.id, role: user.role },
      process.env.JWT_SECRET!,
      { expiresIn: process.env.JWT_EXPIRES_IN }
    );
    
    return { user, token };
  }
  
  // 登录
  async login(email: string, password: string) {
    const user = await prisma.user.findUnique({ where: { email } });
    if (!user) throw new Error('User not found');
    
    const valid = await bcrypt.compare(password, user.password_hash!);
    if (!valid) throw new Error('Invalid password');
    
    const token = jwt.sign(
      { userId: user.id, role: user.role },
      process.env.JWT_SECRET!,
      { expiresIn: process.env.JWT_EXPIRES_IN }
    );
    
    return { user, token };
  }
  
  // Web3 登录
  async loginWithWallet(walletAddress: string, signature: string) {
    // 验证签名...
    
    let user = await prisma.user.findUnique({
      where: { wallet_address: walletAddress }
    });
    
    if (!user) {
      user = await prisma.user.create({
        data: {
          wallet_address: walletAddress,
          role: 'USER',
        },
      });
    }
    
    const token = jwt.sign(
      { userId: user.id, role: user.role },
      process.env.JWT_SECRET!,
      { expiresIn: process.env.JWT_EXPIRES_IN }
    );
    
    return { user, token };
  }
}

export default new AuthService();
```

#### 2. 预售服务

使用已修复的 `PresaleService.fixed.ts`：
```bash
cp backend/src/services/presale/PresaleService.fixed.ts \
   backend/src/services/presale/PresaleService.ts
```

#### 3. 订单服务

使用已修复的 `OrderService.fixed.ts`:
```bash
cp backend/src/services/order/OrderService.fixed.ts \
   backend/src/services/order/OrderService.ts
```

---

### 二、前端页面开发

#### 1. 创建首页

`frontend/src/app/page.tsx`:

```typescript
'use client';

import { useState, useEffect } from 'react';
import axios from 'axios';
import PresaleCard from '@/components/PresaleCard';
import FilterBar from '@/components/FilterBar';

export default function HomePage() {
  const [presales, setPresales] = useState([]);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    loadPresales();
  }, []);
  
  const loadPresales = async () => {
    try {
      const { data } = await axios.get('/api/presales', {
        params: { status: 'ACTIVE' }
      });
      setPresales(data.list);
    } catch (error) {
      console.error('Failed to load presales:', error);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="min-h-screen bg-gray-50">
      {/* Hero Section */}
      <section className="bg-gradient-to-r from-green-600 to-green-800 text-white py-20">
        <div className="container mx-auto px-4 text-center">
          <h1 className="text-5xl font-bold mb-4">
            钜园农业NFT预售平台
          </h1>
          <p className="text-xl mb-8">
            区块链赋能优质农产品，连接生产者与消费者
          </p>
          <button className="bg-white text-green-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100">
            探索预售
          </button>
        </div>
      </section>
      
      {/* Filter Bar */}
      <FilterBar />
      
      {/* Presale List */}
      <section className="container mx-auto px-4 py-12">
        <h2 className="text-3xl font-bold mb-8">热门预售</h2>
        
        {loading ? (
          <div className="text-center py-20">加载中...</div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {presales.map((presale: any) => (
              <PresaleCard key={presale.id} presale={presale} />
            ))}
          </div>
        )}
      </section>
    </div>
  );
}
```

#### 2. 预售详情页

`frontend/src/app/presales/[id]/page.tsx`:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import axios from 'axios';
import { useAccount } from 'wagmi';
import PurchaseModal from '@/components/PurchaseModal';

export default function PresaleDetailPage() {
  const params = useParams();
  const router = useRouter();
  const { address, isConnected } = useAccount();
  
  const [presale, setPresale] = useState<any>(null);
  const [showPurchaseModal, setShowPurchaseModal] = useState(false);
  
  useEffect(() => {
    loadPresaleDetail();
  }, [params.id]);
  
  const loadPresaleDetail = async () => {
    try {
      const { data } = await axios.get(`/api/presales/${params.id}`);
      setPresale(data);
    } catch (error) {
      console.error('Failed to load presale:', error);
    }
  };
  
  const handlePurchase = () => {
    if (!isConnected) {
      alert('请先连接钱包');
      return;
    }
    setShowPurchaseModal(true);
  };
  
  if (!presale) return <div>加载中...</div>;
  
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="container mx-auto px-4 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* 左侧：图片展示 */}
          <div>
            <img
              src={presale.cover_image}
              alt={presale.title}
              className="w-full rounded-lg shadow-lg"
            />
            {/* 图片轮播 */}
          </div>
          
          {/* 右侧：产品信息 */}
          <div>
            <h1 className="text-4xl font-bold mb-4">{presale.title}</h1>
            <p className="text-gray-600 mb-6">{presale.subtitle}</p>
            
            {/* 价格 */}
            <div className="bg-white p-6 rounded-lg shadow mb-6">
              <div className="flex items-baseline gap-4">
                <span className="text-3xl font-bold text-green-600">
                  ¥{presale.pricing.presale_price}
                </span>
                <span className="text-gray-400 line-through">
                  ¥{presale.pricing.market_price}
                </span>
                <span className="text-red-500 font-semibold">
                  {presale.pricing.discount_rate}% OFF
                </span>
              </div>
            </div>
            
            {/* 库存信息 */}
            <div className="bg-white p-6 rounded-lg shadow mb-6">
              <div className="flex justify-between mb-2">
                <span>已售</span>
                <span className="font-semibold">
                  {presale.inventory.sold}/{presale.inventory.total}
                </span>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div
                  className="bg-green-600 h-2 rounded-full"
                  style={{
                    width: `${(presale.inventory.sold / presale.inventory.total) * 100}%`
                  }}
                />
              </div>
            </div>
            
            {/* 购买按钮 */}
            <button
              onClick={handlePurchase}
              className="w-full bg-green-600 text-white py-4 rounded-lg font-semibold text-lg hover:bg-green-700"
            >
              立即购买
            </button>
          </div>
        </div>
        
        {/* 详细描述 */}
        <div className="mt-12">
          <div className="bg-white rounded-lg shadow p-8">
            <h2 className="text-2xl font-bold mb-4">产品详情</h2>
            <div dangerouslySetInnerHTML={{ __html: presale.description }} />
          </div>
        </div>
      </div>
      
      {/* 购买弹窗 */}
      {showPurchaseModal && (
        <PurchaseModal
          presale={presale}
          onClose={() => setShowPurchaseModal(false)}
        />
      )}
    </div>
  );
}
```

---

### 三、智能合约部署

#### 1. 编译合约

```bash
cd contracts
npx hardhat compile
```

#### 2. 部署到测试网

```bash
# 部署NFT合约
npx hardhat run scripts/deploy-nft.ts --network bscTestnet

# 部署托管合约
npx hardhat run scripts/deploy-escrow.ts --network bscTestnet
```

#### 3. 验证合约

```bash
npx hardhat verify --network bscTestnet <合约地址> <构造函数参数>
```

---

### 四、Web3集成

#### 1. 配置RainbowKit

`frontend/src/app/layout.tsx`:

```typescript
'use client';

import '@rainbow-me/rainbowkit/styles.css';
import { RainbowKitProvider, getDefaultWallets } from '@rainbow-me/rainbowkit';
import { configureChains, createConfig, WagmiConfig } from 'wagmi';
import { bscTestnet } from 'wagmi/chains';
import { publicProvider } from 'wagmi/providers/public';

const { chains, publicClient } = configureChains(
  [bscTestnet],
  [publicProvider()]
);

const { connectors } = getDefaultWallets({
  appName: 'Lychee NFT Platform',
  projectId: process.env.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID!,
  chains,
});

const wagmiConfig = createConfig({
  autoConnect: true,
  connectors,
  publicClient,
});

export default function RootLayout({ children }: { children: React.Node }) {
  return (
    <html lang="zh-CN">
      <body>
        <WagmiConfig config={wagmiConfig}>
          <RainbowKitProvider chains={chains}>
            {children}
          </RainbowKitProvider>
        </WagmiConfig>
      </body>
    </html>
  );
}
```

#### 2. 连接钱包按钮

```typescript
import { ConnectButton } from '@rainbow-me/rainbowkit';

export default function Header() {
  return (
    <header>
      <nav>
        {/* ... */}
        <ConnectButton />
      </nav>
    </header>
  );
}
```

---

## 🔧 开发工具

### 推荐的IDE插件

- **VSCode**:
  - Prisma
  - ESLint
  - Prettier
  - Tailwind CSS IntelliSense
  - Solidity
  - GitLens

### 数据库管理

```bash
# Prisma Studio (可视化数据库管理)
cd backend
npx prisma studio
```

### API测试

推荐使用 **Postman** 或 **Thunder Client** (VSCode插件)

导入API集合：`docs/api/postman_collection.json`

---

## 📖 相关文档

- [完整修复报告](./docs/technical/逻辑错误修复报告.md)
- [修复前后对比](./docs/technical/修复前后对比.md)
- [API文档](./docs/api/README.md)
- [智能合约文档](./contracts/README.md)
- [部署指南](./deployment/README.md)

---

## 🎯 下一步建议

1. **立即开始**：
   ```bash
   # 启动开发环境
   npm run dev
   ```

2. **优先实现**：
   - 用户认证API
   - 预售列表页面
   - 订单创建流程

3. **测试验证**：
   - 注册/登录流程
   - 预售浏览
   - 购买下单

4. **逐步完善**：
   - 支付集成
   - NFT铸造
   - 管理后台

---

## 🆘 需要帮助？

如果遇到任何问题，请：
1. 查看错误日志
2. 检查环境变量配置
3. 查阅相关文档
4. 随时向我提问！

---

**开始构建您的NFT预售平台吧！** 🚀

有任何问题，随时告诉我！

