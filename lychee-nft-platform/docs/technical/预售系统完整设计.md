# 荔枝NFT预售系统完整设计方案

> 一套完整的、可直接实施的预售系统技术方案

## 📋 目录

- [系统概述](#系统概述)
- [系统架构](#系统架构)
- [核心功能模块](#核心功能模块)
- [数据库设计](#数据库设计)
- [API接口设计](#api接口设计)
- [前端页面设计](#前端页面设计)
- [智能合约设计](#智能合约设计)
- [业务流程](#业务流程)
- [部署方案](#部署方案)

---

## 系统概述

### 系统定位

一个集成了区块链技术的农产品NFT预售平台，支持：
- 🎯 多品类农产品预售
- 💰 资金托管和分段释放
- 📦 全流程溯源追踪
- 🔒 第三方担保交易
- 🌍 全球用户访问

### 核心特性

```
┌─────────────────────────────────────────────────┐
│               荔枝NFT预售系统                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  预售管理 → 支付托管 → 生产追踪 → 物流配送      │
│     ↓          ↓          ↓          ↓          │
│  订单管理   资金管理   溯源系统   收货确认       │
│     ↓          ↓          ↓          ↓          │
│  NFT铸造   智能合约   数据上链   评价系统        │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 技术栈

| 层级 | 技术选型 |
|------|---------|
| **前端** | Next.js 14 + React 18 + TypeScript + Tailwind CSS |
| **后端** | Node.js 18 + Express + TypeScript + Prisma ORM |
| **数据库** | PostgreSQL 15 + Redis 7 |
| **区块链** | Solidity + Hardhat + Ethers.js + IPFS |
| **部署** | Docker + Kubernetes + CI/CD |

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         用户层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │微信小程序│  │ H5/Web  │  │管理后台  │  │基地端App │   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │
└───────┼─────────────┼─────────────┼─────────────┼─────────┘
        │             │             │             │
┌───────┼─────────────┼─────────────┼─────────────┼─────────┐
│       └─────────────┴─────────────┴─────────────┘         │
│                    API Gateway层                           │
│           ┌──────────────────────────────┐                │
│           │  Nginx + Rate Limit + Auth   │                │
│           └──────────────────────────────┘                │
└─────────────────────────────────────────────────────────────┘
        │
┌───────┴─────────────────────────────────────────────────────┐
│                    业务服务层（微服务）                       │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │预售服务 │ │订单服务 │ │支付服务 │ │溯源服务 │          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │NFT服务  │ │用户服务 │ │物流服务 │ │消息服务 │          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
└─────────────────────────────────────────────────────────────┘
        │                                         │
┌───────┴─────────────────────┐      ┌──────────┴──────────┐
│      数据存储层              │      │    区块链层          │
│  ┌──────────┐ ┌──────────┐ │      │  ┌───────────────┐  │
│  │PostgreSQL│ │  Redis   │ │      │  │ Smart Contracts│  │
│  └──────────┘ └──────────┘ │      │  └───────────────┘  │
│  ┌──────────┐ ┌──────────┐ │      │  ┌───────────────┐  │
│  │   IPFS   │ │   OSS    │ │      │  │   Ethereum    │  │
│  └──────────┘ └──────────┘ │      │  │   Polygon     │  │
└─────────────────────────────┘      └─────────────────────┘
```

### 微服务架构

每个服务独立部署，通过API Gateway统一对外：

```typescript
// 服务列表
const services = {
  presale: {
    port: 4001,
    domain: 'presale-service',
    description: '预售管理服务'
  },
  order: {
    port: 4002,
    domain: 'order-service',
    description: '订单管理服务'
  },
  payment: {
    port: 4003,
    domain: 'payment-service',
    description: '支付托管服务'
  },
  nft: {
    port: 4004,
    domain: 'nft-service',
    description: 'NFT铸造服务'
  },
  trace: {
    port: 4005,
    domain: 'trace-service',
    description: '溯源追踪服务'
  },
  logistics: {
    port: 4006,
    domain: 'logistics-service',
    description: '物流配送服务'
  },
  user: {
    port: 4007,
    domain: 'user-service',
    description: '用户管理服务'
  }
};
```

---

## 核心功能模块

### 1. 预售管理模块

#### 功能清单

```
预售管理
├── 预售活动创建
│   ├── 基本信息设置
│   ├── 价格策略配置
│   ├── 库存数量管理
│   └── 时间节点设置
├── 预售活动管理
│   ├── 活动状态控制
│   ├── 库存实时更新
│   ├── 价格动态调整
│   └── 活动数据统计
├── NFT配置
│   ├── NFT元数据设置
│   ├── 权益规则配置
│   ├── 稀缺性管理
│   └── 批量铸造设置
└── 预售审核
    ├── 资质审核
    ├── 内容审核
    ├── 价格审核
    └── 合规审核
```

#### 预售活动生命周期

```
[创建] → [审核] → [预热] → [进行中] → [售罄/结束] → [归档]
   ↓        ↓        ↓         ↓            ↓           ↓
 草稿     待审核   即将开始   销售中      已完成      历史记录
   ↓        ↓        ↓         ↓            ↓           ↓
 可编辑   可撤回   可取消    可暂停      生成报告    仅查看
```

#### 数据模型

```typescript
// 预售活动模型
interface PresaleActivity {
  // 基本信息
  id: string;
  presale_number: string;  // 预售编号 PS20240001
  title: string;           // 活动标题
  subtitle: string;        // 副标题
  description: string;     // 详细描述
  cover_image: string;     // 封面图片
  banner_images: string[]; // 轮播图片
  
  // 产品信息
  product: {
    category: string;      // 产品类别：lychee/longan/mango
    variety: string;       // 品种：恐龙蛋/桂味/糯米糍
    grade: string;         // 等级：特级/一级/二级
    weight: number;        // 重量（斤）
    unit: string;          // 单位
    specs: object;         // 规格参数
  };
  
  // 价格策略
  pricing: {
    original_price: number;    // 原价
    presale_price: number;     // 预售价
    discount_rate: number;     // 折扣率
    deposit: number;           // 定金（0表示全款）
    final_payment: number;     // 尾款
    group_discount: object;    // 团购优惠
    early_bird_discount: object; // 早鸟优惠
  };
  
  // 库存管理
  inventory: {
    total: number;             // 总库存
    available: number;         // 可售库存
    reserved: number;          // 预留库存
    sold: number;              // 已售数量
    min_purchase: number;      // 最小购买量
    max_purchase: number;      // 最大购买量
    limit_per_user: number;    // 每人限购
  };
  
  // 时间节点
  timeline: {
    presale_start: Date;       // 预售开始
    presale_end: Date;         // 预售结束
    harvest_start: Date;       // 采摘开始
    harvest_end: Date;         // 采摘结束
    delivery_deadline: Date;   // 发货截止
    deposit_deadline: Date;    // 尾款截止（如有定金）
  };
  
  // NFT配置
  nft_config: {
    collection_name: string;   // NFT系列名称
    contract_address: string;  // 合约地址
    token_id_start: number;    // 起始Token ID
    metadata_uri: string;      // 元数据URI
    rights: string[];          // 持有权益
    transferable: boolean;     // 是否可转让
    royalty_rate: number;      // 版税比例
  };
  
  // 配送信息
  shipping: {
    regions: string[];         // 配送区域
    free_shipping: boolean;    // 是否包邮
    shipping_fee: number;      // 运费
    cold_chain: boolean;       // 是否冷链
    insurance: boolean;        // 是否保险
    estimated_days: number;    // 预计天数
  };
  
  // 活动标签
  tags: string[];              // 标签：热门/新品/限量
  
  // 状态信息
  status: PresaleStatus;       // 活动状态
  audit_status: AuditStatus;   // 审核状态
  
  // 卖家信息
  orchard: {
    id: string;
    name: string;
    location: string;
    certification: string[];
    rating: number;
  };
  
  // 统计数据
  stats: {
    views: number;             // 浏览量
    likes: number;             // 点赞数
    shares: number;            // 分享数
    conversion_rate: number;   // 转化率
  };
  
  // 时间戳
  created_at: Date;
  updated_at: Date;
  published_at: Date;
}

// 预售状态枚举
enum PresaleStatus {
  DRAFT = 'draft',           // 草稿
  PENDING = 'pending',       // 待审核
  APPROVED = 'approved',     // 已审核
  SCHEDULED = 'scheduled',   // 已排期
  ACTIVE = 'active',         // 进行中
  PAUSED = 'paused',         // 已暂停
  SOLD_OUT = 'sold_out',     // 已售罄
  ENDED = 'ended',           // 已结束
  CANCELLED = 'cancelled',   // 已取消
  ARCHIVED = 'archived'      // 已归档
}
```

### 2. 订单管理模块

#### 订单状态流转

```
创建订单 → 待支付 → 已支付 → 生产中 → 待发货 → 已发货 → 
待收货 → 已完成 → 已评价

         ↓
      可取消/退款
         ↓
      已取消/已退款
```

#### 订单数据模型

```typescript
interface Order {
  // 基本信息
  order_id: string;          // 订单ID
  order_number: string;      // 订单号 ORD20240315001
  
  // 关联信息
  user_id: string;           // 买家ID
  presale_id: string;        // 预售活动ID
  nft_token_id: string;      // NFT Token ID
  
  // 商品信息
  product_info: {
    name: string;
    variety: string;
    grade: string;
    weight: number;
    quantity: number;
    unit_price: number;
  };
  
  // 金额信息
  amount: {
    product_amount: number;   // 商品金额
    shipping_fee: number;     // 运费
    discount_amount: number;  // 优惠金额
    coupon_amount: number;    // 优惠券金额
    total_amount: number;     // 订单总额
    paid_amount: number;      // 实付金额
    refund_amount: number;    // 退款金额
  };
  
  // 资金分配（托管）
  escrow: {
    platform_fee: number;     // 平台服务费 5%
    logistics_fee: number;    // 物流费 10%
    initial_payment: number;  // 首款 30%
    final_payment: number;    // 尾款 55%
    released_amount: number;  // 已释放金额
    locked_amount: number;    // 锁定金额
  };
  
  // 收货信息
  shipping_address: {
    recipient: string;        // 收件人
    phone: string;            // 电话
    province: string;         // 省份
    city: string;             // 城市
    district: string;         // 区县
    address: string;          // 详细地址
    postal_code: string;      // 邮编
    note: string;             // 备注
  };
  
  // 物流信息
  logistics: {
    company: string;          // 物流公司
    tracking_number: string;  // 运单号
    shipped_at: Date;         // 发货时间
    delivered_at: Date;       // 签收时间
    estimated_delivery: Date; // 预计送达
    status: string;           // 物流状态
    trace: LogisticsTrace[];  // 物流轨迹
  };
  
  // 支付信息
  payment: {
    method: string;           // 支付方式
    channel: string;          // 支付渠道
    transaction_id: string;   // 交易流水号
    paid_at: Date;            // 支付时间
    blockchain_tx: string;    // 区块链交易哈希
  };
  
  // 状态信息
  status: OrderStatus;        // 订单状态
  payment_status: string;     // 支付状态
  shipment_status: string;    // 发货状态
  refund_status: string;      // 退款状态
  
  // 评价信息
  review: {
    rating: number;           // 评分 1-5
    comment: string;          // 评价内容
    photos: string[];         // 晒单图片
    tags: string[];           // 标签
    reviewed_at: Date;        // 评价时间
  };
  
  // 售后信息
  after_sales: {
    type: string;             // 售后类型
    reason: string;           // 售后原因
    status: string;           // 售后状态
    apply_at: Date;           // 申请时间
    resolve_at: Date;         // 解决时间
  };
  
  // 时间戳
  created_at: Date;
  updated_at: Date;
  paid_at: Date;
  confirmed_at: Date;
  completed_at: Date;
}
```

### 3. 支付托管模块

#### 支付流程

```
选择支付方式 → 创建支付订单 → 调用支付接口 → 
支付成功回调 → 资金托管 → 分段释放

支持的支付方式：
├── 微信支付
├── 支付宝
├── 银联支付
├── ETH支付
├── USDT支付
└── 其他加密货币
```

#### 资金托管合约

```solidity
// 简化版托管合约
contract EscrowManager {
    struct Escrow {
        address buyer;
        address seller;
        uint256 totalAmount;
        uint256 platformFee;     // 5%
        uint256 logisticsFee;    // 10%
        uint256 initialPayment;  // 30%
        uint256 finalPayment;    // 55%
        uint256 releasedAmount;
        EscrowStatus status;
        uint256 createdAt;
        uint256 deliveryDeadline;
    }
    
    mapping(bytes32 => Escrow) public escrows;
    
    // 创建托管
    function createEscrow(
        bytes32 orderId,
        address seller,
        uint256 deliveryDeadline
    ) external payable {
        require(msg.value > 0, "Invalid amount");
        
        uint256 amount = msg.value;
        Escrow storage escrow = escrows[orderId];
        
        escrow.buyer = msg.sender;
        escrow.seller = seller;
        escrow.totalAmount = amount;
        escrow.platformFee = amount * 5 / 100;
        escrow.logisticsFee = amount * 10 / 100;
        escrow.initialPayment = amount * 30 / 100;
        escrow.finalPayment = amount * 55 / 100;
        escrow.status = EscrowStatus.Locked;
        escrow.createdAt = block.timestamp;
        escrow.deliveryDeadline = deliveryDeadline;
        
        // 立即扣除平台费
        payable(platform).transfer(escrow.platformFee);
        
        emit EscrowCreated(orderId, msg.sender, seller, amount);
    }
    
    // 发货释放（首款+物流费）
    function releaseOnShipment(bytes32 orderId) external onlySeller {
        Escrow storage escrow = escrows[orderId];
        require(escrow.status == EscrowStatus.Locked);
        
        uint256 releaseAmount = escrow.initialPayment + escrow.logisticsFee;
        payable(escrow.seller).transfer(releaseAmount);
        escrow.releasedAmount += releaseAmount;
        escrow.status = EscrowStatus.Shipped;
        
        emit FundsReleased(orderId, escrow.seller, releaseAmount);
    }
    
    // 确认收货释放（尾款）
    function releaseOnDelivery(bytes32 orderId) external onlyBuyer {
        Escrow storage escrow = escrows[orderId];
        require(escrow.status == EscrowStatus.Shipped);
        
        payable(escrow.seller).transfer(escrow.finalPayment);
        escrow.releasedAmount += escrow.finalPayment;
        escrow.status = EscrowStatus.Completed;
        
        emit DeliveryConfirmed(orderId, escrow.finalPayment);
    }
}
```

---

## 数据库设计

### ER图

```
Users (用户表)
├── user_id (PK)
├── wallet_address
├── username
├── role
└── created_at

Presales (预售活动表)
├── presale_id (PK)
├── orchard_id (FK)
├── product_info (JSONB)
├── pricing (JSONB)
├── inventory (JSONB)
├── status
└── created_at

Orders (订单表)
├── order_id (PK)
├── user_id (FK)
├── presale_id (FK)
├── nft_token_id
├── amount (JSONB)
├── status
└── created_at

NFTs (NFT表)
├── token_id (PK)
├── contract_address
├── owner_address
├── metadata_uri
├── status
└── minted_at

Traces (溯源记录表)
├── trace_id (PK)
├── nft_token_id (FK)
├── stage
├── data (JSONB)
├── blockchain_hash
└── created_at

Logistics (物流表)
├── logistics_id (PK)
├── order_id (FK)
├── tracking_number
├── status
├── trace (JSONB)
└── updated_at
```

### 核心表SQL

```sql
-- 预售活动表
CREATE TABLE presales (
    presale_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    presale_number VARCHAR(20) UNIQUE NOT NULL,
    title VARCHAR(200) NOT NULL,
    subtitle VARCHAR(500),
    description TEXT,
    cover_image VARCHAR(500),
    banner_images TEXT[],
    
    -- 产品信息（JSONB）
    product_info JSONB NOT NULL,
    
    -- 价格策略（JSONB）
    pricing JSONB NOT NULL,
    
    -- 库存管理（JSONB）
    inventory JSONB NOT NULL,
    
    -- 时间节点（JSONB）
    timeline JSONB NOT NULL,
    
    -- NFT配置（JSONB）
    nft_config JSONB,
    
    -- 配送信息（JSONB）
    shipping JSONB,
    
    -- 果园信息
    orchard_id UUID NOT NULL REFERENCES orchards(orchard_id),
    
    -- 状态
    status VARCHAR(20) NOT NULL DEFAULT 'draft',
    audit_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    
    -- 标签
    tags TEXT[],
    
    -- 统计数据（JSONB）
    stats JSONB DEFAULT '{}',
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP,
    
    -- 索引
    INDEX idx_status (status),
    INDEX idx_orchard (orchard_id),
    INDEX idx_created (created_at DESC),
    INDEX idx_product (((product_info->>'category'))),
    FULLTEXT INDEX idx_search (title, description)
);

-- 订单表
CREATE TABLE orders (
    order_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    order_number VARCHAR(30) UNIQUE NOT NULL,
    
    -- 关联
    user_id UUID NOT NULL REFERENCES users(user_id),
    presale_id UUID NOT NULL REFERENCES presales(presale_id),
    nft_token_id BIGINT,
    
    -- 商品信息（JSONB）
    product_info JSONB NOT NULL,
    
    -- 金额信息（JSONB）
    amount JSONB NOT NULL,
    
    -- 托管信息（JSONB）
    escrow JSONB,
    
    -- 收货地址（JSONB）
    shipping_address JSONB NOT NULL,
    
    -- 物流信息（JSONB）
    logistics JSONB,
    
    -- 支付信息（JSONB）
    payment JSONB,
    
    -- 状态
    status VARCHAR(20) NOT NULL DEFAULT 'pending_payment',
    payment_status VARCHAR(20) DEFAULT 'unpaid',
    shipment_status VARCHAR(20) DEFAULT 'not_shipped',
    refund_status VARCHAR(20) DEFAULT 'none',
    
    -- 评价（JSONB）
    review JSONB,
    
    -- 售后（JSONB）
    after_sales JSONB,
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    paid_at TIMESTAMP,
    shipped_at TIMESTAMP,
    delivered_at TIMESTAMP,
    confirmed_at TIMESTAMP,
    completed_at TIMESTAMP,
    
    -- 索引
    INDEX idx_user (user_id),
    INDEX idx_presale (presale_id),
    INDEX idx_status (status),
    INDEX idx_created (created_at DESC)
);

-- NFT表
CREATE TABLE nfts (
    token_id BIGINT PRIMARY KEY,
    contract_address VARCHAR(42) NOT NULL,
    collection_name VARCHAR(100),
    
    -- 所有者
    owner_address VARCHAR(42) NOT NULL,
    
    -- 元数据
    metadata_uri VARCHAR(500),
    metadata JSONB,
    
    -- 关联订单
    order_id UUID REFERENCES orders(order_id),
    presale_id UUID REFERENCES presales(presale_id),
    
    -- 权益信息（JSONB）
    rights JSONB,
    
    -- 状态
    status VARCHAR(20) DEFAULT 'locked',
    transferable BOOLEAN DEFAULT FALSE,
    
    -- 交易历史（JSONB数组）
    transaction_history JSONB DEFAULT '[]',
    
    -- 时间戳
    minted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    transferred_at TIMESTAMP,
    
    -- 索引
    INDEX idx_owner (owner_address),
    INDEX idx_contract (contract_address),
    INDEX idx_order (order_id)
);

-- 溯源记录表
CREATE TABLE trace_records (
    trace_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- 关联
    nft_token_id BIGINT REFERENCES nfts(token_id),
    presale_id UUID REFERENCES presales(presale_id),
    order_id UUID REFERENCES orders(order_id),
    
    -- 溯源阶段
    stage VARCHAR(50) NOT NULL,
    stage_index INT NOT NULL,
    
    -- 溯源数据（JSONB）
    data JSONB NOT NULL,
    
    -- 媒体文件
    photos TEXT[],
    videos TEXT[],
    
    -- 环境数据（JSONB）
    environment_data JSONB,
    
    -- 区块链信息
    blockchain_hash VARCHAR(66),
    blockchain_timestamp BIGINT,
    
    -- 审核状态
    verified BOOLEAN DEFAULT FALSE,
    verifier_id UUID REFERENCES users(user_id),
    verified_at TIMESTAMP,
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    uploaded_at TIMESTAMP,
    
    -- 索引
    INDEX idx_nft (nft_token_id),
    INDEX idx_stage (stage),
    INDEX idx_created (created_at DESC)
);
```

---

## API接口设计

### RESTful API规范

```
基础URL: https://api.lychee-nft.com/v1

认证方式: 
- Bearer Token (JWT)
- API Key

响应格式:
{
  "success": boolean,
  "data": any,
  "message": string,
  "code": number,
  "timestamp": number
}
```

### 核心接口列表

#### 1. 预售管理API

```typescript
// 获取预售列表
GET /presales
Query: {
  page?: number;
  limit?: number;
  category?: string;    // 产品类别
  status?: string;      // 状态筛选
  sort?: string;        // 排序方式
  keyword?: string;     // 搜索关键词
}
Response: {
  success: true,
  data: {
    list: Presale[],
    total: number,
    page: number,
    limit: number
  }
}

// 获取预售详情
GET /presales/:presaleId
Response: {
  success: true,
  data: PresaleDetail
}

// 创建预售活动（果园端）
POST /presales
Body: CreatePresaleDTO
Response: {
  success: true,
  data: {
    presale_id: string,
    presale_number: string
  }
}

// 更新预售活动
PATCH /presales/:presaleId
Body: UpdatePresaleDTO

// 审核预售活动（管理端）
POST /presales/:presaleId/review
Body: {
  approved: boolean,
  reason?: string
}

// 发布预售活动
POST /presales/:presaleId/publish

// 暂停预售活动
POST /presales/:presaleId/pause

// 获取预售统计
GET /presales/:presaleId/stats
```

#### 2. 订单管理API

```typescript
// 创建订单
POST /orders/create
Body: {
  presale_id: string,
  quantity: number,
  shipping_address: Address,
  coupon_code?: string
}
Response: {
  success: true,
  data: {
    order_id: string,
    order_number: string,
    amount: OrderAmount,
    payment_info: PaymentInfo
  }
}

// 支付订单
POST /orders/:orderId/pay
Body: {
  payment_method: string,
  payment_channel: string
}
Response: {
  success: true,
  data: {
    payment_url?: string,
    qr_code?: string,
    payment_params: any
  }
}

// 支付回调
POST /orders/payment/callback
Body: PaymentCallbackData

// 确认发货（果园端）
POST /orders/:orderId/ship
Body: {
  tracking_number: string,
  logistics_company: string,
  package_photos: string[]
}

// 确认收货（买家端）
POST /orders/:orderId/confirm

// 申请售后
POST /orders/:orderId/after-sales
Body: {
  type: string,
  reason: string,
  evidence: string[]
}

// 获取订单列表
GET /orders
Query: {
  user_id?: string,
  status?: string,
  page?: number,
  limit?: number
}

// 获取订单详情
GET /orders/:orderId

// 取消订单
POST /orders/:orderId/cancel

// 订单评价
POST /orders/:orderId/review
Body: {
  rating: number,
  comment: string,
  photos?: string[],
  tags?: string[]
}
```

#### 3. NFT管理API

```typescript
// 铸造NFT
POST /nfts/mint
Body: {
  presale_id: string,
  order_id: string,
  owner_address: string,
  metadata: NFTMetadata
}

// 获取NFT列表
GET /nfts
Query: {
  owner_address?: string,
  collection?: string,
  page?: number,
  limit?: number
}

// 获取NFT详情
GET /nfts/:tokenId

// 转移NFT
POST /nfts/:tokenId/transfer
Body: {
  to_address: string,
  signature: string
}

// 获取NFT历史
GET /nfts/:tokenId/history
```

#### 4. 溯源管理API

```typescript
// 上传溯源数据（果园端）
POST /trace/upload
Body: {
  nft_token_id: string,
  stage: string,
  data: TraceData,
  photos?: string[],
  videos?: string[]
}

// 获取溯源记录
GET /trace/:tokenId
Response: {
  success: true,
  data: {
    timeline: TraceRecord[],
    current_stage: string,
    completion_rate: number
  }
}

// 验证溯源数据
GET /trace/verify/:traceId
Response: {
  success: true,
  data: {
    verified: boolean,
    blockchain_hash: string,
    blockchain_timestamp: number
  }
}
```

---

## 前端页面设计

### 页面结构

```
微信小程序（买家端）
├── pages/
│   ├── index/              # 首页
│   ├── presale/
│   │   ├── list/          # 预售列表
│   │   └── detail/        # 预售详情
│   ├── order/
│   │   ├── confirm/       # 确认订单
│   │   ├── pay/           # 支付页面
│   │   ├── list/          # 订单列表
│   │   └── detail/        # 订单详情
│   ├── nft/
│   │   ├── list/          # 我的NFT
│   │   └── detail/        # NFT详情
│   ├── trace/             # 溯源追踪
│   └── user/              # 个人中心

管理后台（中介端）
├── pages/
│   ├── dashboard/         # 数据看板
│   ├── presales/          # 预售管理
│   ├── orders/            # 订单管理
│   ├── users/             # 用户管理
│   ├── nfts/              # NFT管理
│   ├── orchards/          # 果园管理
│   ├── finance/           # 财务管理
│   └── settings/          # 系统设置

果园端（H5/APP）
├── pages/
│   ├── home/              # 工作台
│   ├── presales/          # 预售管理
│   ├── orders/            # 订单管理
│   ├── trace/             # 溯源上传
│   ├── logistics/         # 物流管理
│   └── finance/           # 收益管理
```

### 核心页面原型

#### 预售详情页

```jsx
// 预售详情页组件
export default function PresaleDetailPage() {
  return (
    <div className="presale-detail">
      {/* 轮播图 */}
      <Swiper images={bannerImages} />
      
      {/* 基本信息 */}
      <div className="info-section">
        <h1>{presale.title}</h1>
        <div className="price">
          <span className="presale-price">¥{presalePrice}</span>
          <span className="original-price">¥{originalPrice}</span>
          <span className="discount">{discount}折</span>
        </div>
        <div className="sales">
          已售{soldCount}/{totalCount}
        </div>
      </div>
      
      {/* 倒计时 */}
      <Countdown endTime={presaleEnd} />
      
      {/* 产品详情 */}
      <div className="product-detail">
        <Tabs>
          <Tab label="产品介绍">
            <RichContent html={description} />
          </Tab>
          <Tab label="规格参数">
            <SpecTable specs={specs} />
          </Tab>
          <Tab label="果园介绍">
            <OrchardInfo orchard={orchard} />
          </Tab>
          <Tab label="用户评价">
            <ReviewList reviews={reviews} />
          </Tab>
        </Tabs>
      </div>
      
      {/* 底部购买栏 */}
      <div className="bottom-bar">
        <Button onClick={handleAddToCart}>
          加入购物车
        </Button>
        <Button type="primary" onClick={handleBuyNow}>
          立即购买
        </Button>
      </div>
    </div>
  );
}
```

#### 确认订单页

```jsx
export default function OrderConfirmPage() {
  return (
    <div className="order-confirm">
      {/* 收货地址 */}
      <AddressSelector
        value={selectedAddress}
        onChange={setSelectedAddress}
      />
      
      {/* 商品信息 */}
      <div className="product-info">
        <img src={coverImage} />
        <div className="detail">
          <h3>{productName}</h3>
          <p>{specs}</p>
          <div className="price-quantity">
            <span>¥{price}</span>
            <span>×{quantity}</span>
          </div>
        </div>
      </div>
      
      {/* 配送方式 */}
      <div className="delivery-method">
        <Radio.Group value={deliveryMethod}>
          <Radio value="standard">
            标准配送（预计{estimatedDays}天送达）
          </Radio>
          <Radio value="express">
            加急配送（额外¥{expressFee}）
          </Radio>
        </Radio.Group>
      </div>
      
      {/* 优惠券 */}
      <CouponSelector
        available={availableCoupons}
        selected={selectedCoupon}
        onChange={setSelectedCoupon}
      />
      
      {/* 金额明细 */}
      <div className="amount-detail">
        <div className="item">
          <span>商品金额</span>
          <span>¥{productAmount}</span>
        </div>
        <div className="item">
          <span>运费</span>
          <span>{shippingFee === 0 ? '包邮' : `¥${shippingFee}`}</span>
        </div>
        <div className="item discount">
          <span>优惠</span>
          <span>-¥{discountAmount}</span>
        </div>
        <div className="item total">
          <span>实付款</span>
          <span className="price">¥{totalAmount}</span>
        </div>
      </div>
      
      {/* 提交订单 */}
      <Button
        type="primary"
        size="large"
        onClick={handleSubmit}
        loading={submitting}
      >
        提交订单
      </Button>
    </div>
  );
}
```

---

## 智能合约设计

### 合约架构

```
LycheeNFT生态合约
├── LycheeNFT.sol            # NFT合约（ERC-721）
├── PresaleManager.sol       # 预售管理合约
├── EscrowManager.sol        # 资金托管合约
├── GovernanceToken.sol      # 治理代币合约
└── Marketplace.sol          # 二级市场合约
```

### 核心合约代码

#### 预售管理合约

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/security/Pausable.sol";

contract PresaleManager is Ownable, ReentrancyGuard, Pausable {
    
    struct Presale {
        bytes32 presaleId;
        address orchard;
        uint256 price;
        uint256 totalSupply;
        uint256 soldCount;
        uint256 startTime;
        uint256 endTime;
        bool active;
        mapping(address => uint256) purchases;
    }
    
    mapping(bytes32 => Presale) public presales;
    address public escrowManager;
    address public nftContract;
    
    event PresaleCreated(
        bytes32 indexed presaleId,
        address orchard,
        uint256 price,
        uint256 totalSupply
    );
    
    event Purchase(
        bytes32 indexed presaleId,
        address buyer,
        uint256 quantity,
        uint256 amount
    );
    
    constructor(
        address _escrowManager,
        address _nftContract
    ) {
        escrowManager = _escrowManager;
        nftContract = _nftContract;
    }
    
    // 创建预售活动
    function createPresale(
        bytes32 presaleId,
        address orchard,
        uint256 price,
        uint256 totalSupply,
        uint256 startTime,
        uint256 endTime
    ) external onlyOwner {
        require(presales[presaleId].presaleId == bytes32(0), "Presale exists");
        require(totalSupply > 0, "Invalid supply");
        require(endTime > startTime, "Invalid time");
        
        Presale storage presale = presales[presaleId];
        presale.presaleId = presaleId;
        presale.orchard = orchard;
        presale.price = price;
        presale.totalSupply = totalSupply;
        presale.startTime = startTime;
        presale.endTime = endTime;
        presale.active = true;
        
        emit PresaleCreated(presaleId, orchard, price, totalSupply);
    }
    
    // 购买NFT
    function purchase(
        bytes32 presaleId,
        uint256 quantity
    ) external payable nonReentrant whenNotPaused {
        Presale storage presale = presales[presaleId];
        
        require(presale.active, "Presale inactive");
        require(block.timestamp >= presale.startTime, "Not started");
        require(block.timestamp <= presale.endTime, "Ended");
        require(quantity > 0, "Invalid quantity");
        require(
            presale.soldCount + quantity <= presale.totalSupply,
            "Sold out"
        );
        
        uint256 totalPrice = presale.price * quantity;
        require(msg.value >= totalPrice, "Insufficient payment");
        
        // 更新销售数量
        presale.soldCount += quantity;
        presale.purchases[msg.sender] += quantity;
        
        // 转入托管合约
        (bool success, ) = escrowManager.call{value: msg.value}(
            abi.encodeWithSignature(
                "createEscrow(bytes32,address,address,uint256)",
                presaleId,
                msg.sender,
                presale.orchard,
                msg.value
            )
        );
        require(success, "Escrow failed");
        
        emit Purchase(presaleId, msg.sender, quantity, msg.value);
        
        // 退还多余金额
        if (msg.value > totalPrice) {
            payable(msg.sender).transfer(msg.value - totalPrice);
        }
    }
    
    // 查询预售信息
    function getPresale(bytes32 presaleId) 
        external 
        view 
        returns (
            address orchard,
            uint256 price,
            uint256 totalSupply,
            uint256 soldCount,
            uint256 startTime,
            uint256 endTime,
            bool active
        ) 
    {
        Presale storage presale = presales[presaleId];
        return (
            presale.orchard,
            presale.price,
            presale.totalSupply,
            presale.soldCount,
            presale.startTime,
            presale.endTime,
            presale.active
        );
    }
    
    // 查询用户购买数量
    function getUserPurchases(
        bytes32 presaleId,
        address user
    ) external view returns (uint256) {
        return presales[presaleId].purchases[user];
    }
}
```

---

## 业务流程

### 完整预售流程时序图

```
用户          前端          后端          合约          果园
 │             │             │             │             │
 │─浏览预售───→│             │             │             │
 │             │─获取列表───→│             │             │
 │             │←返回数据────│             │             │
 │             │             │             │             │
 │─下单购买───→│             │             │             │
 │             │─创建订单───→│             │             │
 │             │             │─锁定库存───→│             │
 │             │             │←返回订单────│             │
 │             │←返回支付信息│             │             │
 │             │             │             │             │
 │─完成支付───→│             │             │             │
 │             │─支付回调───→│             │             │
 │             │             │─创建托管───→│             │
 │             │             │             │─扣除平台费─→│
 │             │             │             │─锁定剩余款─→│
 │             │             │←返回结果────│             │
 │             │             │─铸造NFT────→│             │
 │             │             │←NFT信息────│             │
 │             │←支付成功────│             │             │
 │             │             │             │             │
 │             │             │             │             │
 │             │             │             │      ┌───生产期───┐
 │             │             │             │      │  种植养护   │
 │─查看溯源───→│             │             │      │  数据上传   │
 │             │─获取溯源───→│             │      └─────────────┘
 │             │             │←溯源数据────│             │
 │             │←展示溯源────│             │             │
 │             │             │             │             │
 │             │             │             │             │
 │             │             │             │      ┌───采摘期───┐
 │             │             │             │      │  采摘打包   │
 │             │             │             │      │  确认发货   │
 │             │             │←发货通知────│─────────────────────│
 │             │             │─释放首款───→│             │
 │             │             │             │─支付首款───→│
 │             │             │             │─支付物流费─→│
 │             │←发货通知────│             │             │
 │             │             │             │             │
 │             │             │             │             │
 │─收到货物───→│             │             │             │
 │─确认收货───→│             │             │             │
 │             │─确认收货───→│             │             │
 │             │             │─释放尾款───→│             │
 │             │             │             │─支付尾款───→│
 │             │             │←完成交易────│             │
 │             │←交易完成────│             │             │
 │             │             │             │             │
 │─评价晒单───→│             │             │             │
 │             │─提交评价───→│             │             │
 │             │             │─更新信用───→│             │
 │             │←评价成功────│             │             │
```

---

## 部署方案

### Docker部署

所有服务都已配置在Docker Compose中：

```yaml
# 预售服务已包含在 docker-compose.yml 中
# 可直接使用：
cd deployment/docker
make prod
```

### Kubernetes部署

```yaml
# k8s/presale-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: presale-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: presale-service
  template:
    metadata:
      labels:
        app: presale-service
    spec:
      containers:
      - name: presale-service
        image: lychee-nft/presale-service:latest
        ports:
        - containerPort: 4001
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: url
```

---

## 总结

这套预售系统包含：

✅ **完整的功能模块**
- 预售管理
- 订单管理
- 支付托管
- NFT铸造
- 溯源追踪
- 物流配送

✅ **完整的技术方案**
- 微服务架构设计
- 数据库表结构
- RESTful API接口
- 智能合约代码
- 前端页面原型

✅ **完整的业务流程**
- 从创建预售到确认收货
- 资金分段释放机制
- 争议处理流程
- 信用评分体系

✅ **完整的部署方案**
- Docker容器化
- Kubernetes编排
- 监控告警
- 备份恢复

**可直接用于开发实施！**

---

**文档版本**: 1.0  
**创建日期**: 2025-10-05  
**作者**: Lychee NFT Platform Team
