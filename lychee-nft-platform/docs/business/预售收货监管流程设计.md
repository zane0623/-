# 荔枝NFT预售、收货及第三方监管流程设计

> 参考美团消费券模式，构建安全可信的农产品NFT预售交易闭环

## 📋 目录

- [业务模式概述](#业务模式概述)
- [完整流程图](#完整流程图)
- [预售流程](#预售流程)
- [收货流程](#收货流程)
- [第三方监管流程](#第三方监管流程)
- [资金管理](#资金管理)
- [争议处理](#争议处理)
- [技术实现](#技术实现)

---

## 业务模式概述

### 核心理念

**类比美团消费券**：平台作为可信第三方，在买卖双方之间提供担保服务，确保"钱货两清"。

```
买家 ←→ 平台（担保方） ←→ 卖家（果园）
        ↓
    智能合约（链上担保）
```

### 三方角色

| 角色 | 职责 | 权限 |
|------|------|------|
| **买家** | 购买NFT、确认收货、评价 | 支付、确认、申诉 |
| **卖家（果园）** | 生产、发货、提现 | 上传溯源、发货、收款 |
| **平台（监管方）** | 担保资金、监管流程、处理纠纷 | 冻结/释放资金、仲裁 |
| **智能合约** | 自动执行、资金托管 | 按规则自动执行 |

### 关键机制

1. **资金托管** - 买家付款后资金冻结在智能合约中
2. **分段释放** - 按确认收货、质量验收等节点分段释放资金
3. **超时机制** - 超过期限自动确认或退款
4. **争议仲裁** - 平台介入处理纠纷
5. **信用体系** - 买卖双方信用评分影响交易

---

## 完整流程图

### 整体流程

```
┌─────────────────────────────────────────────────────────────┐
│                    荔枝NFT交易完整流程                        │
└─────────────────────────────────────────────────────────────┘

阶段1: 预售期
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 上架NFT  │ →  │ 用户浏览 │ →  │ 下单支付 │ →  │ 资金托管 │
│ (果园)   │    │ (买家)   │    │ (买家)   │    │ (合约)   │
└──────────┘    └──────────┘    └──────────┘    └──────────┘

阶段2: 生产期
┌──────────┐    ┌──────────┐    ┌──────────┐
│ 种植养护 │ →  │ 上传溯源 │ →  │ 用户查看 │
│ (果园)   │    │ (果园)   │    │ (买家)   │
└──────────┘    └──────────┘    └──────────┘

阶段3: 采摘配送期
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 采摘打包 │ →  │ 发货通知 │ →  │ 物流追踪 │ →  │ 签收通知 │
│ (果园)   │    │ (果园)   │    │ (物流)   │    │ (买家)   │
└──────────┘    └──────────┘    └──────────┘    └──────────┘

阶段4: 确认收货期
┌──────────┐    ┌──────────┐    ┌──────────┐
│ 验收荔枝 │ →  │ 确认收货 │ →  │ 释放资金 │
│ (买家)   │    │ (买家)   │    │ (合约)   │
└──────────┘    └──────────┘    └──────────┘
                      ↓
                 可选: 申诉
                      ↓
            ┌──────────────┐
            │ 平台介入仲裁 │
            └──────────────┘

阶段5: 售后期
┌──────────┐    ┌──────────┐    ┌──────────┐
│ 评价晒单 │ →  │ 积分奖励 │ →  │ 信用更新 │
│ (买家)   │    │ (平台)   │    │ (系统)   │
└──────────┘    └──────────┘    └──────────┘
```

---

## 预售流程

### 1. 预售准备（果园操作）

#### 1.1 创建预售活动

**操作步骤**：
```
1. 果园登录生产基地端
2. 填写预售信息：
   - 荔枝品种（恐龙蛋）
   - 预售数量（1000份）
   - 预售价格（298元/份）
   - 预计采摘时间（2024年6月）
   - 配送范围（全国）
3. 上传果园认证资料
4. 设置NFT元数据
5. 提交平台审核
```

**数据结构**：
```json
{
  "presale_id": "PS20240001",
  "orchard_id": "OR001",
  "product": {
    "name": "钜园恐龙蛋荔枝",
    "variety": "恐龙蛋",
    "weight": "5斤/份",
    "grade": "特级",
    "description": "广东茂名钜园农业恐龙蛋荔枝..."
  },
  "pricing": {
    "presale_price": 298.00,
    "market_price": 398.00,
    "discount_rate": 0.25
  },
  "quantity": {
    "total": 1000,
    "available": 1000,
    "sold": 0
  },
  "timeline": {
    "presale_start": "2024-03-01",
    "presale_end": "2024-05-31",
    "harvest_date": "2024-06-15",
    "delivery_deadline": "2024-06-30"
  },
  "status": "pending_review"
}
```

#### 1.2 平台审核

**审核内容**：
- ✅ 果园资质验证
- ✅ 产品信息真实性
- ✅ 价格合理性
- ✅ 供应能力评估
- ✅ 历史信用记录

**审核流程**：
```
提交 → 初审（自动） → 人工审核 → 批准/驳回
      ↓
   风控检查
      ↓
   资质核验
```

**审核通过后**：
- 生成NFT合约地址
- 铸造NFT到果园钱包
- 上架到预售市场
- 发送通知给果园

### 2. 用户下单（买家操作）

#### 2.1 浏览选购

**用户界面**：
```
┌─────────────────────────────────────┐
│  🍈 恐龙蛋荔枝NFT - 限量预售         │
├─────────────────────────────────────┤
│  [荔枝图片]                          │
│                                      │
│  ⭐⭐⭐⭐⭐ 4.9分 (328条评价)          │
│                                      │
│  💰 ¥298  原价: ¥398  省¥100        │
│                                      │
│  📦 预计6月中旬发货                  │
│  🚚 包邮到家 | 坏果包赔              │
│                                      │
│  📊 已售: 568/1000                   │
│  ⏰ 距结束: 45天23小时               │
│                                      │
│  [查看溯源] [立即购买]               │
└─────────────────────────────────────┘
```

#### 2.2 下单支付

**支付流程**：
```
1. 选择数量（默认1份）
2. 填写收货地址
3. 选择支付方式：
   ✓ 微信支付
   ✓ 支付宝
   ✓ USDT（链上支付）
   ✓ 银行卡
4. 确认订单信息
5. 完成支付
```

**订单数据**：
```json
{
  "order_id": "ORD20240315001",
  "buyer_id": "USER123",
  "presale_id": "PS20240001",
  "nft_token_id": "1001",
  "payment": {
    "amount": 298.00,
    "method": "wechat_pay",
    "transaction_id": "WX20240315123456",
    "paid_at": "2024-03-15 10:30:25"
  },
  "shipping": {
    "recipient": "张三",
    "phone": "138****8888",
    "address": "广东省广州市天河区...",
    "note": "请在工作日送货"
  },
  "status": "paid",
  "created_at": "2024-03-15 10:28:30"
}
```

### 3. 资金托管（智能合约自动执行）

#### 3.1 资金锁定

**合约逻辑**：
```solidity
function purchaseNFT(uint256 tokenId) public payable {
    require(msg.value >= presalePrice, "Insufficient payment");
    
    // 资金锁定在合约中
    escrowBalance[tokenId] = msg.value;
    
    // 记录买家
    buyers[tokenId] = msg.sender;
    
    // 转移NFT所有权（但标记为锁定状态）
    _transfer(seller, msg.sender, tokenId);
    nftStatus[tokenId] = Status.Locked;
    
    // 记录托管信息
    escrows[tokenId] = Escrow({
        buyer: msg.sender,
        seller: seller,
        amount: msg.value,
        status: EscrowStatus.Locked,
        createdAt: block.timestamp,
        deliveryDeadline: harvestDate + 15 days
    });
    
    emit NFTPurchased(tokenId, msg.sender, msg.value);
}
```

#### 3.2 资金分配规则

**分段释放机制**：
```
总金额: 298元

分配方案:
├─ 平台服务费(5%): 14.90元 → 立即扣除
├─ 物流费用(10%): 29.80元 → 发货时释放给物流
├─ 果园首款(30%): 89.40元 → 发货时释放
├─ 果园尾款(55%): 164.90元 → 确认收货后释放
└─ 总计: 298.00元

时间线:
支付时 → 平台扣除服务费
发货时 → 释放物流费 + 首款
收货后 → 释放尾款（7天后自动或手动确认）
```

### 4. NFT铸造与转移

**NFT元数据**：
```json
{
  "name": "钜园恐龙蛋荔枝 #1001",
  "description": "2024年广东茂名钜园农业恐龙蛋荔枝预售NFT",
  "image": "ipfs://Qm...",
  "attributes": [
    {
      "trait_type": "品种",
      "value": "恐龙蛋"
    },
    {
      "trait_type": "重量",
      "value": "5斤"
    },
    {
      "trait_type": "等级",
      "value": "特级"
    },
    {
      "trait_type": "产地",
      "value": "广东茂名"
    },
    {
      "trait_type": "预计采摘时间",
      "value": "2024-06"
    },
    {
      "trait_type": "订单号",
      "value": "ORD20240315001"
    }
  ],
  "external_url": "https://lychee-nft.com/nft/1001",
  "rights": [
    "提货权：2024年6月采摘季可兑换5斤恐龙蛋荔枝",
    "溯源权：查看完整生产溯源数据",
    "转让权：可在二级市场转让NFT",
    "分红权：果园盈利时按持有比例分红"
  ]
}
```

---

## 收货流程

### 1. 生产期追踪（果园操作）

#### 1.1 溯源数据上传

**数据类型**：
```
定期上传（每周）:
├─ 果树生长照片
├─ 环境数据（温度、湿度、降雨）
├─ 养护记录（施肥、修剪、病虫害防治）
├─ 质检报告
└─ 视频记录

里程碑事件:
├─ 开花期（拍照上传）
├─ 坐果期（拍照上传）
├─ 膨果期（每周更新）
├─ 成熟期（质检报告）
└─ 采摘期（采摘视频）
```

**溯源数据结构**：
```json
{
  "trace_id": "TR20240401001",
  "nft_token_id": "1001",
  "date": "2024-04-01",
  "stage": "flowering",
  "data": {
    "photos": [
      "ipfs://Qm.../flower1.jpg",
      "ipfs://Qm.../flower2.jpg"
    ],
    "environment": {
      "temperature_avg": 25.5,
      "humidity_avg": 75.2,
      "rainfall": 15.3
    },
    "maintenance": {
      "fertilizer": "有机肥",
      "pest_control": "生物防治",
      "pruning": "疏花疏果"
    },
    "notes": "果树开花情况良好，预计坐果率85%以上"
  },
  "blockchain_hash": "0x...",
  "uploaded_at": "2024-04-01 15:30:00"
}
```

#### 1.2 用户查看溯源

**小程序界面**：
```
┌─────────────────────────────────────┐
│  我的荔枝 #1001                      │
├─────────────────────────────────────┤
│  [果树实时照片]                      │
│                                      │
│  📍 当前阶段: 膨果期                 │
│  📅 已生长: 45天                     │
│  🌡️ 今日温度: 28°C                   │
│  💧 今日湿度: 72%                    │
│                                      │
│  ──── 生长时间线 ────               │
│  ✅ 2024-03-15 购买NFT               │
│  ✅ 2024-03-20 开花期                │
│  ✅ 2024-04-01 坐果期                │
│  🔵 2024-04-15 膨果期（当前）        │
│  ⏳ 2024-06-15 成熟采摘              │
│                                      │
│  [查看详细溯源] [邀请好友围观]       │
└─────────────────────────────────────┘
```

### 2. 采摘配送期（果园 + 物流）

#### 2.1 采摘打包

**果园操作流程**：
```
1. 到期提醒:
   - 系统提前7天提醒果园准备采摘
   - 通知用户预计采摘时间
   
2. 采摘作业:
   - 按订单批次采摘
   - 现场拍照/视频记录
   - 质检分级
   
3. 打包装箱:
   - 精选装箱（每份5斤，约15-20颗）
   - 加冰袋保鲜
   - 贴订单标签（含二维码）
   - 封箱拍照
   
4. 称重复核:
   - 验证重量≥5斤
   - 拍照上传
   - 生成发货凭证
```

**打包数据**：
```json
{
  "package_id": "PKG20240615001",
  "order_id": "ORD20240315001",
  "nft_token_id": "1001",
  "harvest_data": {
    "picked_at": "2024-06-15 06:30:00",
    "picker": "李师傅",
    "tree_number": "A区-15号树",
    "photos": [
      "ipfs://Qm.../harvest1.jpg",
      "ipfs://Qm.../harvest2.jpg"
    ]
  },
  "package_data": {
    "weight": 5.2,
    "quantity": 18,
    "grade": "特级",
    "box_photo": "ipfs://Qm.../box.jpg",
    "qr_code": "https://lychee-nft.com/track/PKG20240615001"
  },
  "packed_at": "2024-06-15 08:00:00"
}
```

#### 2.2 发货通知

**系统自动触发**：
```
1. 果园点击"确认发货"
2. 上传快递单号
3. 触发智能合约事件
4. 释放首款（30%）+ 物流费（10%）给果园
5. 发送通知给买家
6. 开始倒计时（15天收货期限）
```

**发货数据**：
```json
{
  "shipment_id": "SHIP20240615001",
  "order_id": "ORD20240315001",
  "logistics": {
    "company": "顺丰速运",
    "tracking_number": "SF1234567890",
    "shipped_at": "2024-06-15 10:00:00",
    "estimated_arrival": "2024-06-17"
  },
  "payment_released": {
    "to_orchard": 89.40,
    "to_logistics": 29.80,
    "timestamp": "2024-06-15 10:01:00",
    "tx_hash": "0x..."
  }
}
```

**买家收到通知**：
```
┌─────────────────────────────────────┐
│  📦 您的荔枝已发货                   │
├─────────────────────────────────────┤
│  您的恐龙蛋荔枝已由钜园农业发出      │
│                                      │
│  物流: 顺丰速运                      │
│  单号: SF1234567890                  │
│  预计: 6月17日送达                   │
│                                      │
│  [实时追踪] [联系果园]               │
└─────────────────────────────────────┘
```

#### 2.3 物流追踪

**物流状态同步**：
```
物流节点实时更新:
├─ 2024-06-15 10:30 揽件成功（茂名市）
├─ 2024-06-15 18:45 到达转运中心（茂名）
├─ 2024-06-16 02:15 到达转运中心（广州）
├─ 2024-06-16 15:30 派件中（天河区）
└─ 2024-06-17 09:45 已签收

异常状态处理:
├─ 运输延迟 → 通知买家 + 延长收货期
├─ 包裹破损 → 拍照上传 + 申请理赔
├─ 地址错误 → 联系买家 + 修改地址
└─ 无人签收 → 联系买家 + 快递柜/代收
```

### 3. 确认收货期（买家操作）

#### 3.1 签收验货

**签收提醒**：
```
┌─────────────────────────────────────┐
│  ✅ 您的荔枝已送达                   │
├─────────────────────────────────────┤
│  快递已签收，请及时验收              │
│                                      │
│  📋 验收提示:                        │
│  1. 检查包装是否完好                 │
│  2. 称重是否足够（≥5斤）             │
│  3. 荔枝是否新鲜                     │
│  4. 有无破损/变质                    │
│                                      │
│  请在7天内确认收货                   │
│  如有问题请及时申诉                  │
│                                      │
│  [确认收货] [申请售后]               │
└─────────────────────────────────────┘
```

#### 3.2 确认收货

**确认流程**：
```
方式一: 主动确认（推荐）
用户检查无误 → 点击"确认收货" → 触发合约 → 释放尾款

方式二: 自动确认（超时）
签收后7天 → 系统自动确认 → 触发合约 → 释放尾款

方式三: 申诉处理
发现问题 → 申请售后 → 平台介入 → 仲裁结果 → 资金处理
```

**确认收货合约**：
```solidity
function confirmDelivery(uint256 tokenId) public {
    require(buyers[tokenId] == msg.sender, "Not buyer");
    require(escrows[tokenId].status == EscrowStatus.Shipped, "Not shipped");
    
    Escrow storage escrow = escrows[tokenId];
    
    // 释放尾款给果园（55%）
    uint256 finalPayment = escrow.amount * 55 / 100;
    payable(escrow.seller).transfer(finalPayment);
    
    // 解锁NFT
    nftStatus[tokenId] = Status.Unlocked;
    
    // 更新托管状态
    escrow.status = EscrowStatus.Completed;
    escrow.confirmedAt = block.timestamp;
    
    emit DeliveryConfirmed(tokenId, msg.sender, finalPayment);
}

// 自动确认（7天后）
function autoConfirmDelivery(uint256 tokenId) public {
    Escrow storage escrow = escrows[tokenId];
    require(escrow.status == EscrowStatus.Shipped, "Not shipped");
    require(block.timestamp >= escrow.deliveredAt + 7 days, "Too early");
    
    // 执行确认逻辑（同上）
    _confirmDelivery(tokenId);
}
```

### 4. 评价晒单（买家操作）

#### 4.1 评价系统

**评价维度**：
```
整体评分: ⭐⭐⭐⭐⭐ (1-5星)

细分评分:
├─ 荔枝品质: ⭐⭐⭐⭐⭐
├─ 重量足够: ⭐⭐⭐⭐⭐
├─ 包装完好: ⭐⭐⭐⭐⭐
├─ 物流速度: ⭐⭐⭐⭐⭐
└─ 服务态度: ⭐⭐⭐⭐⭐

文字评价: （选填）
照片上传: （最多9张）
视频上传: （选填）

标签选择:
☑ 果肉饱满  ☑ 口感清甜  ☑ 新鲜多汁
☑ 包装精美  ☑ 发货及时  □ 分量不足
```

**评价奖励**：
```
晒单奖励规则:
├─ 文字评价（≥30字）: 10积分
├─ 图片晒单（≥3张）: 20积分
├─ 视频晒单: 50积分
├─ 精华评价（优质内容）: 100积分
└─ 积分可兑换: 优惠券、下次预售优先权
```

---

## 第三方监管流程

### 1. 平台监管职责

#### 1.1 全流程监管

**监管内容**：
```
预售阶段:
├─ 果园资质审核
├─ 产品信息审查
├─ 价格合理性监控
├─ 预售数量核验
└─ 合规性检查

生产阶段:
├─ 溯源数据审核
├─ 生产进度跟踪
├─ 质量标准检查
└─ 异常情况预警

配送阶段:
├─ 发货及时性监控
├─ 物流状态追踪
├─ 配送质量抽检
└─ 客户投诉处理

收货阶段:
├─ 确认收货监控
├─ 纠纷处理介入
├─ 资金安全保障
└─ 信用评分更新
```

#### 1.2 风控系统

**实时监控指标**：
```
果园端风险:
├─ 发货延迟率 > 10% → 黄色预警
├─ 投诉率 > 5% → 橙色预警
├─ 退款率 > 15% → 红色预警
└─ 信用分 < 60分 → 暂停销售

买家端风险:
├─ 恶意退款次数 > 3次 → 限制购买
├─ 恶意评价检测 → 账号警告
└─ 信用分 < 60分 → 限制部分功能

系统风险:
├─ 异常交易检测（金额、频率）
├─ 黄牛刷单识别
├─ 资金异常流动监控
└─ 智能合约安全监控
```

### 2. 争议处理机制

#### 2.1 争议类型

**常见争议场景**：
```
质量问题:
├─ 重量不足
├─ 品质不符（烂果、坏果）
├─ 与描述不符
└─ 包装破损

配送问题:
├─ 发货延迟
├─ 物流丢件
├─ 配送超时
└─ 无人签收

服务问题:
├─ 沟通不畅
├─ 售后不理
├─ 承诺不兑现
└─ 态度恶劣
```

#### 2.2 申诉流程

**买家申诉**：
```
步骤1: 发起申诉
├─ 选择问题类型
├─ 上传证据（照片/视频）
├─ 描述问题
└─ 提出诉求（退款/补偿/重发）

步骤2: 果园响应（48小时内）
├─ 查看申诉内容
├─ 提供反证
├─ 协商解决方案
└─ 接受/拒绝诉求

步骤3: 平台介入（果园超时或双方协商不成）
├─ 审查双方证据
├─ 联系物流核实
├─ 参考历史记录
├─ 咨询专家意见
└─ 做出仲裁决定（5个工作日内）

步骤4: 执行仲裁
├─ 全额退款
├─ 部分退款
├─ 补偿（优惠券/积分）
├─ 重新发货
└─ 维持原判
```

**申诉数据**：
```json
{
  "dispute_id": "DSP20240620001",
  "order_id": "ORD20240315001",
  "type": "quality_issue",
  "complainant": {
    "user_id": "USER123",
    "role": "buyer",
    "evidence": [
      "ipfs://Qm.../broken1.jpg",
      "ipfs://Qm.../broken2.jpg",
      "ipfs://Qm.../weight.jpg"
    ],
    "description": "收到的荔枝有5颗已经烂了，实际重量只有4.5斤，比承诺少0.5斤",
    "demand": "申请30%退款"
  },
  "respondent": {
    "orchard_id": "OR001",
    "response": "发货时已拍照验重，5.2斤。可能是运输过程中水分流失。烂果愿意补偿20元",
    "evidence": [
      "ipfs://Qm.../package_before.jpg"
    ]
  },
  "platform_decision": {
    "arbitrator": "ADMIN001",
    "result": "partial_refund",
    "refund_amount": 59.60,
    "refund_rate": 0.20,
    "reason": "综合双方证据，运输过程确有损耗，判定20%退款",
    "decided_at": "2024-06-22 15:30:00"
  },
  "status": "resolved",
  "created_at": "2024-06-20 10:15:00",
  "resolved_at": "2024-06-22 16:00:00"
}
```

#### 2.3 仲裁规则

**退款比例标准**：
```
质量问题:
├─ 轻微瑕疵（1-2颗坏果）: 10%退款
├─ 中等问题（3-5颗坏果）: 20-30%退款
├─ 严重问题（>5颗坏果）: 50%退款
└─ 完全不能食用: 100%退款

重量问题:
├─ 短缺 < 10%: 按短缺比例2倍退款
├─ 短缺 10-20%: 30%退款
├─ 短缺 > 20%: 50%退款
└─ 短缺 > 30%: 80%退款

配送问题:
├─ 延迟1-3天: 赠送优惠券
├─ 延迟3-7天: 10%退款
├─ 延迟 > 7天: 20%退款 + 优惠券
└─ 未配送: 100%退款

双方责任:
├─ 完全是果园责任: 果园承担
├─ 完全是买家责任: 买家承担
├─ 物流责任: 平台协调物流赔偿
└─ 双方责任: 按比例分摊
```

**信用扣分规则**：
```
果园:
├─ 质量问题: -5至-20分
├─ 延迟发货: -10分
├─ 虚假宣传: -30分
├─ 拒绝仲裁: -50分
└─ 恶意违约: 永久封禁

买家:
├─ 恶意申诉: -10分
├─ 无理取闹: -20分
├─ 拒签恶意: -30分
├─ 黄牛刷单: 永久封禁
└─ 信用恢复: 每月+5分（上限）
```

### 3. 资金安全保障

#### 3.1 多重签名机制

**资金释放需要多方签名**：
```
正常流程（2/3签名）:
买家确认 + 智能合约自动 → 释放资金

异常流程（3/3签名）:
买家申诉 + 平台仲裁 + 智能合约执行 → 退款/释放

紧急情况（平台特权）:
系统检测到重大风险 → 平台可暂停资金流动 → 调查后处理
```

**智能合约多签实现**：
```solidity
// 多签钱包合约
contract MultiSigEscrow {
    address public platform;
    address public buyer;
    address public seller;
    
    mapping(uint256 => mapping(address => bool)) public signatures;
    
    function releasePayment(uint256 tokenId, address[] memory signers) public {
        require(signers.length >= 2, "Need at least 2 signatures");
        
        // 验证签名
        for (uint i = 0; i < signers.length; i++) {
            require(
                signatures[tokenId][signers[i]], 
                "Invalid signature"
            );
        }
        
        // 释放资金
        _releaseFunds(tokenId);
    }
    
    // 平台紧急暂停
    function emergencyPause(uint256 tokenId) public onlyPlatform {
        escrows[tokenId].status = EscrowStatus.Paused;
        emit EmergencyPaused(tokenId);
    }
}
```

#### 3.2 保证金制度

**果园保证金**：
```
保证金规则:
├─ 新入驻果园: 10,000元保证金
├─ 优质果园（信用 > 90分）: 5,000元
├─ 顶级果园（信用 > 95分）: 免保证金

保证金用途:
├─ 赔付买家损失
├─ 违约金扣除
├─ 平台处罚
└─ 正常经营不使用

保证金释放:
├─ 申请退出平台
├─ 所有订单完结
├─ 无未解决纠纷
└─ 30天后释放
```

#### 3.3 保险机制

**交易保险**：
```
平台提供免费保险:
├─ 质量保险: 坏果包赔
├─ 运输保险: 丢件全赔
├─ 延误保险: 超时补偿
└─ 信用保险: 卖家跑路平台先赔

保险理赔:
├─ 自动判定: 简单情况自动赔付
├─ 快速理赔: 48小时内到账
├─ 先行赔付: 平台垫付后向果园追偿
└─ 额度上限: 单笔最高2000元
```

---

## 资金管理

### 1. 资金流转图

```
买家支付 ¥298
      ↓
┌──────────────────┐
│  智能合约托管池   │ ← 全额锁定
└──────────────────┘
      ↓
  资金分配（支付时）
      ↓
┌─────┴─────┬─────────┬─────────┬─────────┐
│           │         │         │         │
平台服务费   物流费    首款      尾款
¥14.90     ¥29.80   ¥89.40   ¥164.90
(5%)       (10%)    (30%)    (55%)
│           │         │         │
立即扣除    发货释放  发货释放   收货释放
│           │         │         │
↓           ↓         ↓         ↓
平台账户   物流公司   果园账户  果园账户
```

### 2. 提现机制

**果园提现**：
```
提现条件:
├─ 已确认收货的订单
├─ 资金已释放
├─ 无争议纠纷
└─ 完成实名认证

提现周期:
├─ T+0: 实时到账（收费0.6%）
├─ T+1: 次日到账（免费）
└─ 每周三: 批量结算（免费）

提现限制:
├─ 单日最高: 50,000元
├─ 单月最高: 500,000元
└─ 超额提现需额外审核

提现记录:
所有提现记录永久保存，可追溯
```

### 3. 退款处理

**退款流程**：
```
全额退款:
智能合约 → 扣除已释放部分 → 退回买家

部分退款:
智能合约 → 计算退款金额 → 从托管中扣除 → 退回买家

退款时效:
├─ 自动退款: 实时到账
├─ 仲裁退款: 1-3个工作日
└─ 跨境退款: 3-7个工作日
```

---

## 技术实现

### 1. 智能合约核心代码

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract LycheeNFTPresale is ERC721, Ownable, ReentrancyGuard {
    
    // 托管状态枚举
    enum EscrowStatus {
        None,
        Locked,      // 资金锁定
        Shipped,     // 已发货
        Completed,   // 已完成
        Disputed,    // 有争议
        Refunded     // 已退款
    }
    
    // 托管信息结构
    struct Escrow {
        address buyer;
        address seller;
        uint256 amount;
        EscrowStatus status;
        uint256 createdAt;
        uint256 shippedAt;
        uint256 deliveredAt;
        uint256 confirmedAt;
        uint256 deliveryDeadline;
    }
    
    // 状态变量
    address public platform;
    uint256 public presalePrice;
    uint256 public platformFeeRate = 5;  // 5%
    uint256 public logisticsFeeRate = 10; // 10%
    uint256 public initialPaymentRate = 30; // 30%
    uint256 public finalPaymentRate = 55; // 55%
    
    mapping(uint256 => Escrow) public escrows;
    mapping(uint256 => bool) public nftLocked;
    
    // 事件
    event NFTPurchased(uint256 indexed tokenId, address buyer, uint256 amount);
    event NFTShipped(uint256 indexed tokenId, string trackingNumber);
    event DeliveryConfirmed(uint256 indexed tokenId, address buyer, uint256 amount);
    event DisputeRaised(uint256 indexed tokenId, address buyer, string reason);
    event DisputeResolved(uint256 indexed tokenId, address winner, uint256 refundAmount);
    event FundsReleased(uint256 indexed tokenId, address recipient, uint256 amount);
    
    constructor(uint256 _presalePrice) ERC721("Lychee NFT", "LYCHEE") {
        platform = msg.sender;
        presalePrice = _presalePrice;
    }
    
    // 购买NFT
    function purchaseNFT(uint256 tokenId) public payable nonReentrant {
        require(msg.value >= presalePrice, "Insufficient payment");
        require(_exists(tokenId), "Token does not exist");
        require(ownerOf(tokenId) != msg.sender, "Already owned");
        
        address seller = ownerOf(tokenId);
        
        // 扣除平台服务费
        uint256 platformFee = (msg.value * platformFeeRate) / 100;
        payable(platform).transfer(platformFee);
        
        // 剩余资金锁定在合约中
        uint256 escrowAmount = msg.value - platformFee;
        
        // 转移NFT所有权
        _transfer(seller, msg.sender, tokenId);
        nftLocked[tokenId] = true;
        
        // 创建托管记录
        escrows[tokenId] = Escrow({
            buyer: msg.sender,
            seller: seller,
            amount: escrowAmount,
            status: EscrowStatus.Locked,
            createdAt: block.timestamp,
            shippedAt: 0,
            deliveredAt: 0,
            confirmedAt: 0,
            deliveryDeadline: block.timestamp + 90 days // 3个月交付期限
        });
        
        emit NFTPurchased(tokenId, msg.sender, msg.value);
    }
    
    // 确认发货
    function confirmShipment(uint256 tokenId, string memory trackingNumber) public {
        Escrow storage escrow = escrows[tokenId];
        require(escrow.seller == msg.sender, "Not seller");
        require(escrow.status == EscrowStatus.Locked, "Invalid status");
        require(block.timestamp <= escrow.deliveryDeadline, "Delivery deadline passed");
        
        // 释放物流费 + 首款
        uint256 logisticsFee = (escrow.amount * logisticsFeeRate) / 100;
        uint256 initialPayment = (escrow.amount * initialPaymentRate) / 100;
        uint256 totalRelease = logisticsFee + initialPayment;
        
        payable(escrow.seller).transfer(totalRelease);
        
        escrow.status = EscrowStatus.Shipped;
        escrow.shippedAt = block.timestamp;
        
        emit NFTShipped(tokenId, trackingNumber);
        emit FundsReleased(tokenId, escrow.seller, totalRelease);
    }
    
    // 确认收货
    function confirmDelivery(uint256 tokenId) public nonReentrant {
        Escrow storage escrow = escrows[tokenId];
        require(escrow.buyer == msg.sender, "Not buyer");
        require(escrow.status == EscrowStatus.Shipped, "Not shipped");
        
        // 释放尾款
        uint256 finalPayment = (escrow.amount * finalPaymentRate) / 100;
        payable(escrow.seller).transfer(finalPayment);
        
        // 解锁NFT
        nftLocked[tokenId] = false;
        
        escrow.status = EscrowStatus.Completed;
        escrow.confirmedAt = block.timestamp;
        
        emit DeliveryConfirmed(tokenId, msg.sender, finalPayment);
        emit FundsReleased(tokenId, escrow.seller, finalPayment);
    }
    
    // 自动确认（7天后）
    function autoConfirmDelivery(uint256 tokenId) public {
        Escrow storage escrow = escrows[tokenId];
        require(escrow.status == EscrowStatus.Shipped, "Not shipped");
        require(escrow.shippedAt > 0, "No delivery record");
        require(block.timestamp >= escrow.shippedAt + 7 days, "Too early");
        
        // 执行确认逻辑
        uint256 finalPayment = (escrow.amount * finalPaymentRate) / 100;
        payable(escrow.seller).transfer(finalPayment);
        
        nftLocked[tokenId] = false;
        escrow.status = EscrowStatus.Completed;
        escrow.confirmedAt = block.timestamp;
        
        emit DeliveryConfirmed(tokenId, escrow.buyer, finalPayment);
    }
    
    // 发起争议
    function raiseDispute(uint256 tokenId, string memory reason) public {
        Escrow storage escrow = escrows[tokenId];
        require(escrow.buyer == msg.sender, "Not buyer");
        require(
            escrow.status == EscrowStatus.Shipped || 
            escrow.status == EscrowStatus.Locked,
            "Invalid status"
        );
        
        escrow.status = EscrowStatus.Disputed;
        
        emit DisputeRaised(tokenId, msg.sender, reason);
    }
    
    // 平台仲裁（只有平台可调用）
    function resolveDispute(
        uint256 tokenId,
        bool buyerWins,
        uint256 refundRate
    ) public onlyOwner {
        Escrow storage escrow = escrows[tokenId];
        require(escrow.status == EscrowStatus.Disputed, "Not in dispute");
        require(refundRate <= 100, "Invalid refund rate");
        
        uint256 remainingAmount = escrow.amount - 
            (escrow.amount * logisticsFeeRate / 100) -
            (escrow.amount * initialPaymentRate / 100);
        
        if (buyerWins) {
            // 退款给买家
            uint256 refundAmount = (remainingAmount * refundRate) / 100;
            uint256 sellerAmount = remainingAmount - refundAmount;
            
            if (refundAmount > 0) {
                payable(escrow.buyer).transfer(refundAmount);
            }
            if (sellerAmount > 0) {
                payable(escrow.seller).transfer(sellerAmount);
            }
            
            escrow.status = EscrowStatus.Refunded;
            emit DisputeResolved(tokenId, escrow.buyer, refundAmount);
        } else {
            // 释放给卖家
            payable(escrow.seller).transfer(remainingAmount);
            escrow.status = EscrowStatus.Completed;
            emit DisputeResolved(tokenId, escrow.seller, 0);
        }
        
        nftLocked[tokenId] = false;
    }
    
    // 超时退款（超过交付期限）
    function refundDueToTimeout(uint256 tokenId) public {
        Escrow storage escrow = escrows[tokenId];
        require(escrow.status == EscrowStatus.Locked, "Invalid status");
        require(block.timestamp > escrow.deliveryDeadline, "Not timeout");
        
        // 全额退款给买家
        payable(escrow.buyer).transfer(escrow.amount);
        
        escrow.status = EscrowStatus.Refunded;
        nftLocked[tokenId] = false;
        
        emit DisputeResolved(tokenId, escrow.buyer, escrow.amount);
    }
    
    // 查询托管信息
    function getEscrowInfo(uint256 tokenId) public view returns (Escrow memory) {
        return escrows[tokenId];
    }
}
```

### 2. 后端API设计

```typescript
// 订单API
interface OrderAPI {
  // 创建订单
  POST /api/orders/create
  Body: {
    presale_id: string
    nft_token_id: string
    shipping_address: Address
    payment_method: string
  }
  
  // 支付订单
  POST /api/orders/:orderId/pay
  Body: {
    payment_method: string
    payment_proof: string
  }
  
  // 确认发货
  POST /api/orders/:orderId/ship
  Body: {
    tracking_number: string
    logistics_company: string
    package_photos: string[]
  }
  
  // 确认收货
  POST /api/orders/:orderId/confirm
  Body: {
    rating: number
    comment: string
    photos: string[]
  }
  
  // 发起争议
  POST /api/orders/:orderId/dispute
  Body: {
    reason: string
    evidence: string[]
    demand: string
  }
}

// 溯源API
interface TraceAPI {
  // 上传溯源数据
  POST /api/trace/upload
  Body: {
    nft_token_id: string
    stage: string
    data: TraceData
    photos: string[]
  }
  
  // 查询溯源记录
  GET /api/trace/:tokenId
  Response: TraceRecord[]
}

// 监管API
interface AdminAPI {
  // 审核预售活动
  POST /api/admin/presale/:presaleId/review
  Body: {
    approved: boolean
    reason: string
  }
  
  // 仲裁争议
  POST /api/admin/dispute/:disputeId/resolve
  Body: {
    decision: string
    refund_rate: number
    reason: string
  }
  
  // 风控预警
  GET /api/admin/risk/alerts
  Response: RiskAlert[]
}
```

### 3. 数据库设计

**核心表结构**：
```sql
-- 订单表
CREATE TABLE orders (
    order_id VARCHAR(50) PRIMARY KEY,
    buyer_id VARCHAR(50) NOT NULL,
    seller_id VARCHAR(50) NOT NULL,
    nft_token_id VARCHAR(50) NOT NULL,
    presale_id VARCHAR(50) NOT NULL,
    
    -- 金额信息
    total_amount DECIMAL(10, 2) NOT NULL,
    platform_fee DECIMAL(10, 2) NOT NULL,
    logistics_fee DECIMAL(10, 2) NOT NULL,
    initial_payment DECIMAL(10, 2) NOT NULL,
    final_payment DECIMAL(10, 2) NOT NULL,
    
    -- 状态信息
    status VARCHAR(20) NOT NULL,
    payment_status VARCHAR(20) NOT NULL,
    shipment_status VARCHAR(20) NOT NULL,
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    paid_at TIMESTAMP,
    shipped_at TIMESTAMP,
    delivered_at TIMESTAMP,
    confirmed_at TIMESTAMP,
    
    -- 区块链信息
    blockchain_tx_hash VARCHAR(66),
    escrow_address VARCHAR(42),
    
    INDEX idx_buyer (buyer_id),
    INDEX idx_seller (seller_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- 争议表
CREATE TABLE disputes (
    dispute_id VARCHAR(50) PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    complainant_id VARCHAR(50) NOT NULL,
    respondent_id VARCHAR(50) NOT NULL,
    
    -- 争议内容
    type VARCHAR(50) NOT NULL,
    reason TEXT NOT NULL,
    evidence JSONB,
    demand VARCHAR(200),
    
    -- 响应内容
    response TEXT,
    response_evidence JSONB,
    
    -- 仲裁结果
    arbitrator_id VARCHAR(50),
    decision VARCHAR(50),
    refund_amount DECIMAL(10, 2),
    reason_text TEXT,
    
    -- 状态
    status VARCHAR(20) NOT NULL,
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    responded_at TIMESTAMP,
    resolved_at TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    INDEX idx_order (order_id),
    INDEX idx_status (status)
);

-- 溯源记录表
CREATE TABLE trace_records (
    trace_id VARCHAR(50) PRIMARY KEY,
    nft_token_id VARCHAR(50) NOT NULL,
    presale_id VARCHAR(50) NOT NULL,
    
    -- 溯源数据
    stage VARCHAR(50) NOT NULL,
    data JSONB NOT NULL,
    photos TEXT[],
    blockchain_hash VARCHAR(66),
    
    -- 审核信息
    verified BOOLEAN DEFAULT FALSE,
    verifier_id VARCHAR(50),
    verified_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_nft (nft_token_id),
    INDEX idx_stage (stage),
    INDEX idx_created_at (created_at)
);
```

---

## 总结

### 核心优势

1. **买家保障**
   - ✅ 资金托管，货到付款
   - ✅ 质量问题可申诉退款
   - ✅ 平台担保，无忧购物

2. **卖家保障**
   - ✅ 分段收款，现金流好
   - ✅ 平台流量，销售无忧
   - ✅ 信用体系，优质溢价

3. **平台价值**
   - ✅ 建立信任，撮合交易
   - ✅ 服务费收入稳定
   - ✅ 数据资产积累

### 与美团消费券的相似性

| 维度 | 美团消费券 | 荔枝NFT |
|------|-----------|---------|
| **支付** | 先付款到平台 | 先付款到合约 |
| **消费** | 到店核销 | 确认收货 |
| **结算** | 核销后T+1给商家 | 确认后释放给果园 |
| **保障** | 未消费可退款 | 未收货可退款 |
| **监管** | 平台担保 | 平台+合约双重担保 |

### 创新点

1. **区块链托管** - 比中心化平台更透明可信
2. **NFT权益** - 数字资产可转让、可增值
3. **全程溯源** - 从种植到餐桌全记录
4. **智能合约** - 自动执行，减少人工介入
5. **信用体系** - 链上记录，永久追溯

---

**文档版本**: 1.0  
**创建日期**: 2025-10-05  
**作者**: Lychee NFT Platform Team  
**参考**: 美团消费券、支付宝担保交易、淘宝交易流程
